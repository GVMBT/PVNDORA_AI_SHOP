# ‚ö° PVNDORA Refactoring Plan - Agent 3: Database & Performance Optimization

**–ê–≥–µ–Ω—Ç:** Agent 3 (Database & Performance Optimization)  
**–î–∞—Ç–∞:** 2026-01-27  
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üî¥ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π (–¥–ª—è –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è)  
**–û—Ü–µ–Ω–∫–∞:** 5-7 –¥–Ω–µ–π

**‚ö†Ô∏è –í–ê–ñ–ù–û:** –≠—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç –¥–ª—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–π —Ä–∞–±–æ—Ç—ã —Å Agent 1 –∏ Agent 2. –ú–æ–∂–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ, –Ω–æ –Ω–µ –ø–µ—Ä–µ—Å–µ–∫–∞–µ—Ç—Å—è –ø–æ —Ñ–∞–π–ª–∞–º.

---

## üìã –ö–æ–Ω—Ç–µ–∫—Å—Ç –ø—Ä–æ–µ–∫—Ç–∞

**–¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏:**
- Python 3.12 + FastAPI (Vercel Serverless)
- Supabase PostgreSQL (NO ORM, –ø—Ä—è–º–æ–π SQL —á–µ—Ä–µ–∑ `supabase-py`)
- OpenRouter API + LangGraph (AI –∞–≥–µ–Ω—Ç)
- Telegram Bot API (aiogram)
- Upstash QStash (async workers)
- Upstash Redis (–∫—ç—à)

**–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è:**
- ‚úÖ Single entry point: `api/index.py` (Vercel limit: 12 functions)
- ‚úÖ `supabase-py` –∏–º–µ–µ—Ç async –º–µ—Ç–æ–¥—ã: `await client.table().select().execute()`
- ‚úÖ Domains —É–∂–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç async –º–µ—Ç–æ–¥—ã –ø—Ä–∞–≤–∏–ª—å–Ω–æ
- ‚úÖ –ù–ï –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Supabase Triggers –¥–ª—è –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏

**–¢–µ–∫—É—â–∏–µ –ø—Ä–æ–±–ª–µ–º—ã –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏:**

| –ü—Ä–æ–±–ª–µ–º–∞ | –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ | –ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å |
|----------|------------|-------------|
| **N+1 queries** | 5+ –º–µ—Å—Ç | üî¥ –í—ã—Å–æ–∫–∞—è (–∫—Ä–∏—Ç–∏—á–Ω–æ –ø—Ä–∏ 50+ –ø—Ä–æ–¥—É–∫—Ç–∞—Ö) |
| **–°–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã —á–µ—Ä–µ–∑ to_thread** | 50+ –º–µ—Å—Ç | üî¥ –í—ã—Å–æ–∫–∞—è (overhead, –Ω–µ—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ) |
| **–ü—Ä—è–º—ã–µ –∑–∞–ø—Ä–æ—Å—ã –≤–º–µ—Å—Ç–æ domains** | 50+ –º–µ—Å—Ç | üü° –°—Ä–µ–¥–Ω—è—è (–Ω–∞—Ä—É—à–∞–µ—Ç –∞–±—Å—Ç—Ä–∞–∫—Ü–∏—é) |

**–ö—Ä–∏—Ç–∏—á–Ω–æ –¥–ª—è –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è:**
- –ü—Ä–∏ 50+ –ø—Ä–æ–¥—É–∫—Ç–∞—Ö N+1 queries —Å—Ç–∞–Ω–æ–≤—è—Ç—Å—è –∑–∞–º–µ—Ç–Ω–æ–π –ø—Ä–æ–±–ª–µ–º–æ–π
- `asyncio.to_thread()` –¥–æ–±–∞–≤–ª—è–µ—Ç overhead (–ª–∏—à–Ω—è—è –∏–Ω–¥irection)
- –ü—Ä—è–º—ã–µ –∑–∞–ø—Ä–æ—Å—ã –æ–±—Ö–æ–¥—è—Ç –∞–±—Å—Ç—Ä–∞–∫—Ü–∏–∏ domains

---

## üéØ –ó–∞–¥–∞—á–∏ Agent 3

### Phase 7: Database Query Optimization (–ö–†–ò–¢–ò–ß–ù–û –¥–ª—è –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è, 3-4 –¥–Ω—è) üî¥

#### 7.1 –ò—Å–ø—Ä–∞–≤–∏—Ç—å N+1 queries –≤ ProductRepository (–ö–†–ò–¢–ò–ß–ù–û)

**–ü—Ä–æ–±–ª–µ–º–∞:** –í `ProductRepository.get_all()`, `get_by_id()`, `search()` –¥–ª—è –ö–ê–ñ–î–û–ì–û –ø—Ä–æ–¥—É–∫—Ç–∞ –¥–µ–ª–∞–µ—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω—ã–π –∑–∞–ø—Ä–æ—Å `stock_count`.

**–¢–µ–∫—É—â–∏–π –∫–æ–¥ (–ø—Ä–∏–º–µ—Ä N+1):**
```python
# core/services/repositories/product_repo.py
async def get_all(self, status: str = "active") -> List[Product]:
    result = self.client.table("products").select("*").eq("status", status).execute()
    products = []
    for p in result.data:
        # ‚ö†Ô∏è N+1: –î–ª—è –ö–ê–ñ–î–û–ì–û –ø—Ä–æ–¥—É–∫—Ç–∞ - –æ—Ç–¥–µ–ª—å–Ω—ã–π –∑–∞–ø—Ä–æ—Å!
        stock = self.client.table("stock_items").select("id", count="exact").eq("product_id", p["id"]).eq("status", "available").execute()
        p["stock_count"] = stock.count or 0
        products.append(Product(**p))
    return products
```

**–ü—Ä–æ–±–ª–µ–º–∞:** –ï—Å–ª–∏ 50 –ø—Ä–æ–¥—É–∫—Ç–æ–≤ ‚Üí 50 –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ stock_count. –≠—Ç–æ –Ω–µ –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ—Ç—Å—è.

**–†–µ—à–µ–Ω–∏–µ (–†–ï–ö–û–ú–ï–ù–î–£–ï–¢–°–Ø): –°–æ–∑–¥–∞—Ç—å VIEW `products_with_stock_summary`**

**Checklist:**
- [ ] –°–æ–∑–¥–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é `supabase/migrations/XXX_products_with_stock_summary.sql`
- [ ] –°–æ–∑–¥–∞—Ç—å VIEW `products_with_stock_summary`:
```sql
CREATE OR REPLACE VIEW products_with_stock_summary AS
SELECT 
    p.*,
    COUNT(si.id) FILTER (
        WHERE si.status = 'available' 
        AND (si.expires_at IS NULL OR si.expires_at > NOW())
    ) AS stock_count,
    COUNT(si.id) FILTER (WHERE si.status = 'sold') AS sold_count
FROM products p
LEFT JOIN stock_items si ON p.id = si.product_id
GROUP BY p.id;
```
- [ ] –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é —á–µ—Ä–µ–∑ `mcp_supabase_apply_migration`
- [ ] –û–±–Ω–æ–≤–∏—Ç—å `ProductRepository.get_all()` ‚Äî –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å VIEW –≤–º–µ—Å—Ç–æ —Ç–∞–±–ª–∏—Ü—ã products
- [ ] –û–±–Ω–æ–≤–∏—Ç—å `ProductRepository.get_by_id()` ‚Äî –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å VIEW
- [ ] –û–±–Ω–æ–≤–∏—Ç—å `ProductRepository.search()` ‚Äî –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å VIEW
- [ ] –£–±—Ä–∞—Ç—å —Ü–∏–∫–ª —Å –æ—Ç–¥–µ–ª—å–Ω—ã–º–∏ –∑–∞–ø—Ä–æ—Å–∞–º–∏ stock_count –∏–∑ –≤—Å–µ—Ö 3 –º–µ—Ç–æ–¥–æ–≤
- [ ] –¢–µ—Å—Ç—ã (–ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Å 50+ –ø—Ä–æ–¥—É–∫—Ç–∞–º–∏)
- [ ] Commit: `perf: fix N+1 queries in ProductRepository using products_with_stock_summary VIEW`

**–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ (–µ—Å–ª–∏ VIEW –Ω–µ –ø–æ–¥—Ö–æ–¥–∏—Ç): Batch loading**
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ–¥–∏–Ω –∑–∞–ø—Ä–æ—Å —Å `IN` —Ñ–∏–ª—å—Ç—Ä–æ–º –¥–ª—è –≤—Å–µ—Ö product_ids
- –ù–æ VIEW –ø—Ä–µ–¥–ø–æ—á—Ç–∏—Ç–µ–ª—å–Ω–µ–µ (–ø—Ä–æ—â–µ, –±—ã—Å—Ç—Ä–µ–µ, –ø—Ä–∞–≤–∏–ª—å–Ω–µ–µ —Å —Ç–æ—á–∫–∏ –∑—Ä–µ–Ω–∏—è SQL)

**–§–∞–π–ª—ã –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è:**
- `supabase/migrations/XXX_products_with_stock_summary.sql` (–Ω–æ–≤–∞—è –º–∏–≥—Ä–∞—Ü–∏—è)
- `core/services/repositories/product_repo.py` (–æ–±–Ω–æ–≤–∏—Ç—å 3 –º–µ—Ç–æ–¥–∞: `get_all`, `get_by_id`, `search`)

#### 7.2 –ò—Å–ø—Ä–∞–≤–∏—Ç—å N+1 queries –≤ –¥—Ä—É–≥–∏—Ö –º–µ—Å—Ç–∞—Ö (–ö–†–ò–¢–ò–ß–ù–û)

**–ú–µ—Å—Ç–∞ —Å N+1 queries:**

| –§–∞–π–ª | –°—Ç—Ä–æ–∫–∏ | –ü—Ä–æ–±–ª–µ–º–∞ |
|------|--------|----------|
| `core/routers/admin/products.py` | 81-84 | –¶–∏–∫–ª —Å –∑–∞–ø—Ä–æ—Å–∞–º–∏ stock_count –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø—Ä–æ–¥—É–∫—Ç–∞ |
| `core/bot/discount/handlers/catalog.py` | 90-98 | –¶–∏–∫–ª —Å –∑–∞–ø—Ä–æ—Å–∞–º–∏ stock_count –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø—Ä–æ–¥—É–∫—Ç–∞ |
| `core/routers/webapp/public.py` | 182-184 | Query –∫ `available_stock_with_discounts` –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø—Ä–æ–¥—É–∫—Ç–∞ |

**–†–µ—à–µ–Ω–∏–µ:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å VIEW `products_with_stock_summary` –∏–ª–∏ batch loading.

**Checklist:**
- [ ] –ò—Å–ø—Ä–∞–≤–∏—Ç—å N+1 –≤ `core/routers/admin/products.py:81-84`:
  - [ ] –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å VIEW `products_with_stock_summary` –≤–º–µ—Å—Ç–æ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
  - [ ] –ò–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å batch loading —á–µ—Ä–µ–∑ –æ–¥–∏–Ω –∑–∞–ø—Ä–æ—Å —Å `IN` —Ñ–∏–ª—å—Ç—Ä–æ–º
- [ ] –ò—Å–ø—Ä–∞–≤–∏—Ç—å N+1 –≤ `core/bot/discount/handlers/catalog.py:90-98`:
  - [ ] –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å VIEW –∏–ª–∏ batch loading
- [ ] –ò—Å–ø—Ä–∞–≤–∏—Ç—å N+1 –≤ `core/routers/webapp/public.py:182-184`:
  - [ ] –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å VIEW `products_with_stock_summary` –≤–º–µ—Å—Ç–æ `available_stock_with_discounts` –¥–ª—è stock_count
  - [ ] –ò–ª–∏ –¥–æ–±–∞–≤–∏—Ç—å stock_count –≤ `available_stock_with_discounts` VIEW (–Ω–æ —ç—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å —Å–ª–æ–∂–Ω–µ–µ)
- [ ] –¢–µ—Å—Ç—ã (–ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Å 50+ –ø—Ä–æ–¥—É–∫—Ç–∞–º–∏)
- [ ] Commit: `perf: fix N+1 queries in admin/products, discount/catalog, webapp/public`

**–§–∞–π–ª—ã –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è:**
- `core/routers/admin/products.py:81-84`
- `core/bot/discount/handlers/catalog.py:90-98`
- `core/routers/webapp/public.py:182-184`

#### 7.3 –ó–∞–º–µ–Ω–∏—Ç—å `asyncio.to_thread` –Ω–∞ async (50+ –º–µ—Å—Ç)

**–ü—Ä–æ–±–ª–µ–º–∞:** `supabase-py` —É–∂–µ async, –Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ —á–µ—Ä–µ–∑ `asyncio.to_thread` –≤ 50+ –º–µ—Å—Ç–∞—Ö.

**–¢–µ–∫—É—â–∏–π –ø–∞—Ç—Ç–µ—Ä–Ω (–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ):**
```python
# ‚ùå –°—Ç–∞—Ä—ã–π –ø–∞—Ç—Ç–µ—Ä–Ω (50+ –º–µ—Å—Ç):
result = await asyncio.to_thread(
    lambda: db.client.table("users").select("*").eq("id", user_id).execute()
)
```

**–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–∞—Ç—Ç–µ—Ä–Ω:**
```python
# ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–∞—Ç—Ç–µ—Ä–Ω (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ domains):
result = await db.client.table("users").select("*").eq("id", user_id).execute()
```

**–ú–µ—Å—Ç–∞ —Å `asyncio.to_thread`:**
- `core/routers/webapp/profile.py`: 21+ –º–µ—Å—Ç
- `core/routers/workers.py`: 10+ –º–µ—Å—Ç (–Ω–æ Agent 2 —Ä–∞–∑–æ–±—å—ë—Ç –Ω–∞ –º–æ–¥—É–ª–∏)
- `core/routers/webhooks.py`: 5+ –º–µ—Å—Ç
- `core/routers/admin/replacements.py`: 5+ –º–µ—Å—Ç
- `core/routers/webapp/partner.py`: 3+ –º–µ—Å—Ç–∞
- `api/cron/daily_cleanup.py`: 4 –º–µ—Å—Ç–∞

**‚ö†Ô∏è –í–ê–ñ–ù–û:** Agent 2 —Ä–∞–∑–æ–±—å—ë—Ç –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ —Ñ–∞–π–ª—ã –Ω–∞ –º–æ–¥—É–ª–∏, –Ω–æ —ç—Ç–æ –Ω–µ –≤–ª–∏—è–µ—Ç –Ω–∞ –∑–∞–º–µ–Ω—É `asyncio.to_thread`.

**Checklist:**
- [ ] –ó–∞–º–µ–Ω–∏—Ç—å –≤—Å–µ `asyncio.to_thread(lambda: db.client.table()...)` –Ω–∞ –ø—Ä—è–º—ã–µ async –≤—ã–∑–æ–≤—ã:
  - [ ] `core/routers/webapp/profile.py` (21+ –º–µ—Å—Ç) ‚Äî –Ω–æ Agent 2 –º–æ–∂–µ—Ç —Ä–∞–∑–±–∏—Ç—å —Ñ–∞–π–ª, —Ç–æ–≥–¥–∞ –∑–∞–º–µ–Ω–∏—Ç—å –≤ –º–æ–¥—É–ª—è—Ö
  - [ ] `core/routers/workers.py` (10+ –º–µ—Å—Ç) ‚Äî Agent 2 —Ä–∞–∑–æ–±—å—ë—Ç, –∑–∞–º–µ–Ω–∏—Ç—å –≤ –º–æ–¥—É–ª—è—Ö
  - [ ] `core/routers/webhooks.py` (5+ –º–µ—Å—Ç)
  - [ ] `core/routers/admin/replacements.py` (5+ –º–µ—Å—Ç)
  - [ ] `core/routers/webapp/partner.py` (3+ –º–µ—Å—Ç–∞)
  - [ ] `api/cron/daily_cleanup.py` (4 –º–µ—Å—Ç–∞)
- [ ] –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ `await` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ
- [ ] –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –æ—à–∏–±–∫–∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- [ ] –¢–µ—Å—Ç—ã (–ø—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –≤—Å–µ –∑–∞–ø—Ä–æ—Å—ã —Ä–∞–±–æ—Ç–∞—é—Ç)
- [ ] Commit: `perf: replace asyncio.to_thread with direct async calls (50+ places)`

**–§–∞–π–ª—ã –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è:**
- `core/routers/webapp/profile.py` (21+ –º–µ—Å—Ç, –Ω–æ –º–æ–∂–µ—Ç –±—ã—Ç—å —Ä–∞–∑–±–∏—Ç Agent 2)
- `core/routers/workers.py` (10+ –º–µ—Å—Ç, Agent 2 —Ä–∞–∑–æ–±—å—ë—Ç ‚Äî –∑–∞–º–µ–Ω–∏—Ç—å –≤ –º–æ–¥—É–ª—è—Ö)
- `core/routers/webhooks.py` (5+ –º–µ—Å—Ç)
- `core/routers/admin/replacements.py` (5+ –º–µ—Å—Ç)
- `core/routers/webapp/partner.py` (3+ –º–µ—Å—Ç–∞)
- `api/cron/daily_cleanup.py` (4 –º–µ—Å—Ç–∞)

#### 7.4 –ú–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –ø—Ä—è–º—ã–µ –∑–∞–ø—Ä–æ—Å—ã –Ω–∞ domains –º–µ—Ç–æ–¥—ã

**–ü—Ä–æ–±–ª–µ–º–∞:** –í —Ä–æ—É—Ç–µ—Ä–∞—Ö –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –ø—Ä—è–º—ã–µ –∑–∞–ø—Ä–æ—Å—ã `db.client.table()` –≤–º–µ—Å—Ç–æ domains –º–µ—Ç–æ–¥–æ–≤.

**–¢–µ–∫—É—â–∏–π –ø–∞—Ç—Ç–µ—Ä–Ω (–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ):**
```python
# ‚ùå –ü—Ä—è–º–æ–π –¥–æ—Å—Ç—É–ø –≤ —Ä–æ—É—Ç–µ—Ä–µ:
result = await db.client.table("orders").select("*").eq("id", order_id).execute()
```

**–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–∞—Ç—Ç–µ—Ä–Ω:**
```python
# ‚úÖ –ß–µ—Ä–µ–∑ domain (–ø—Ä–∞–≤–∏–ª—å–Ω–æ):
order = await db.orders_domain.get_by_id(order_id)
```

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** –≠—Ç–æ —É–∂–µ —á–∞—Å—Ç–∏—á–Ω–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—Å—è –ø—Ä–∏ –∑–∞–º–µ–Ω–µ `asyncio.to_thread`, –Ω–æ –Ω—É–∂–Ω–æ —Ç–∞–∫–∂–µ –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ domains –º–µ—Ç–æ–¥—ã –≥–¥–µ –≤–æ–∑–º–æ–∂–Ω–æ.

**Checklist:**
- [ ] –ù–∞–π—Ç–∏ –≤—Å–µ –ø—Ä—è–º—ã–µ –∑–∞–ø—Ä–æ—Å—ã `db.client.table()` –≤ —Ä–æ—É—Ç–µ—Ä–∞—Ö (50+ –º–µ—Å—Ç –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ —à–∞–≥–∞)
- [ ] –î–ª—è –∫–∞–∂–¥–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, –µ—Å—Ç—å –ª–∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π –º–µ—Ç–æ–¥ –≤ domains:
  - [ ] `db.orders_domain.get_by_id()` ‚Äî –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤–º–µ—Å—Ç–æ `db.client.table("orders").select().eq("id")`
  - [ ] `db.users_domain.get_by_telegram_id()` ‚Äî –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤–º–µ—Å—Ç–æ –ø—Ä—è–º–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
  - [ ] `db.products_domain.get_by_id()` ‚Äî –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤–º–µ—Å—Ç–æ –ø—Ä—è–º–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
  - [ ] –ò —Ç.–¥.
- [ ] –ï—Å–ª–∏ –º–µ—Ç–æ–¥–∞ –Ω–µ—Ç –≤ domains ‚Üí –¥–æ–±–∞–≤–∏—Ç—å –º–µ—Ç–æ–¥ –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π domain
- [ ] –ó–∞–º–µ–Ω–∏—Ç—å –ø—Ä—è–º—ã–µ –∑–∞–ø—Ä–æ—Å—ã –Ω–∞ –≤—ã–∑–æ–≤—ã domains –º–µ—Ç–æ–¥–æ–≤
- [ ] –¢–µ—Å—Ç—ã (–ø—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –≤—Å–µ —Ä–∞–±–æ—Ç–∞–µ—Ç)
- [ ] Commit: `refactor: migrate direct db.client.table() calls to domain methods`

**–§–∞–π–ª—ã –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è:**
- –¢–µ –∂–µ —Ñ–∞–π–ª—ã, —á—Ç–æ –∏ –≤ —à–∞–≥–µ 7.3 (–Ω–æ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ domains)
- `core/services/domains/` (–¥–æ–±–∞–≤–∏—Ç—å –º–µ—Ç–æ–¥—ã, –µ—Å–ª–∏ –∏—Ö –Ω–µ—Ç)

---

## üö® –ü—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏–µ: DEPRECATED –ø–æ–ª—è Order —á–∏—Ç–∞—é—Ç—Å—è

**–ü—Ä–æ–±–ª–µ–º–∞:** `core/routers/webapp/orders.py:373-374, 419` —á–∏—Ç–∞–µ—Ç `o.product_id` (DEPRECATED), —Ö–æ—Ç—è –µ—Å—Ç—å `order_items`.

**‚ö†Ô∏è –í–ê–ñ–ù–û:** Agent 1 –∏—Å–ø—Ä–∞–≤–∏—Ç —ç—Ç–æ –≤ Phase 1. –ù–æ Agent 3 –¥–æ–ª–∂–µ–Ω –∑–Ω–∞—Ç—å –æ–± —ç—Ç–æ–º, —á—Ç–æ–±—ã –Ω–µ —É—Å—É–≥—É–±–∏—Ç—å –ø—Ä–æ–±–ª–µ–º—É.

**–†–µ—à–µ–Ω–∏–µ:** Agent 1 –∏—Å–ø—Ä–∞–≤–∏—Ç. Agent 3 –Ω–µ –¥–æ–ª–∂–µ–Ω —Ä–∞–±–æ—Ç–∞—Ç—å —Å —ç—Ç–∏–º –∫–æ–¥–æ–º, –Ω–æ –¥–æ–ª–∂–µ–Ω –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –Ω–µ —Å–æ–∑–¥–∞—ë—Ç –Ω–æ–≤—ã—Ö –º–µ—Å—Ç —á—Ç–µ–Ω–∏—è DEPRECATED –ø–æ–ª–µ–π.

**Checklist –¥–ª—è Agent 3:**
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –≤ –Ω–æ–≤—ã—Ö/–∏–∑–º–µ–Ω—ë–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–∞—Ö –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `Order.product_id`
- [ ] –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ `order_items` –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è product_id
- [ ] –ï—Å–ª–∏ –Ω—É–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å products –¥–ª—è orders ‚Üí –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `order_items` (–∏—Å—Ç–æ—á–Ω–∏–∫ –ø—Ä–∞–≤–¥—ã)

---

## üìã Checklist –ø–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º —Ä–∞–±–æ—Ç—ã

- [ ] –ü—Ä–æ—á–∏—Ç–∞–Ω –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø—Ä–æ–µ–∫—Ç–∞ (—Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏, –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞, async –ø–∞—Ç—Ç–µ—Ä–Ω—ã)
- [ ] –ü–æ–Ω–∏–º–∞—é –ø—Ä–æ–±–ª–µ–º—É N+1 queries (–∫—Ä–∏—Ç–∏—á–Ω–æ –ø—Ä–∏ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–∏)
- [ ] –ü–æ–Ω–∏–º–∞—é –ø—Ä–æ–±–ª–µ–º—É `asyncio.to_thread` (overhead, –Ω–µ—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ)
- [ ] –ó–Ω–∞—é, –∫–∞–∫–∏–µ —Ñ–∞–π–ª—ã –∏–∑–º–µ–Ω—è—é (ProductRepository, —Ä–æ—É—Ç–µ—Ä—ã, domains)
- [ ] –ì–æ—Ç–æ–≤ —Ä–∞–±–æ—Ç–∞—Ç—å –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ —Å Agent 1 –∏ Agent 2
- [ ] –ü–æ–Ω–∏–º–∞—é, —á—Ç–æ Agent 1 –∏—Å–ø—Ä–∞–≤–∏—Ç DEPRECATED –ø–æ–ª—è, Agent 2 –º–æ–∂–µ—Ç —Ä–∞–∑–±–∏—Ç—å —Ñ–∞–π–ª—ã

---

## ‚úÖ –ö—Ä–∏—Ç–µ—Ä–∏–∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏

**Phase 7 —Å—á–∏—Ç–∞–µ—Ç—Å—è –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω–æ–π, –∫–æ–≥–¥–∞:**
- ‚úÖ VIEW `products_with_stock_summary` —Å–æ–∑–¥–∞–Ω –∏ –ø—Ä–∏–º–µ–Ω—ë–Ω
- ‚úÖ N+1 queries –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã –≤ 5+ –º–µ—Å—Ç–∞—Ö:
  - ‚úÖ `ProductRepository.get_all()`, `get_by_id()`, `search()` (3 –º–µ—Ç–æ–¥–∞)
  - ‚úÖ `admin/products.py:81-84`
  - ‚úÖ `discount/handlers/catalog.py:90-98`
  - ‚úÖ `webapp/public.py:182-184`
- ‚úÖ `asyncio.to_thread` –∑–∞–º–µ–Ω—ë–Ω –Ω–∞ async –≤ 50+ –º–µ—Å—Ç–∞—Ö
- ‚úÖ –ü—Ä—è–º—ã–µ –∑–∞–ø—Ä–æ—Å—ã –º–∏–≥—Ä–∏—Ä–æ–≤–∞–Ω—ã –Ω–∞ domains –º–µ—Ç–æ–¥—ã (–≥–¥–µ –≤–æ–∑–º–æ–∂–Ω–æ)
- ‚úÖ –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø—Ä–æ–≤–µ—Ä–µ–Ω–∞ —Å 50+ –ø—Ä–æ–¥—É–∫—Ç–∞–º–∏ (N+1 –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ)
- ‚úÖ –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç
- ‚úÖ Commit —Å–¥–µ–ª–∞–Ω

**–ú–µ—Ç—Ä–∏–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏:**
- **–î–æ:** 50 –ø—Ä–æ–¥—É–∫—Ç–æ–≤ ‚Üí 50+ –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –ë–î (N+1)
- **–ü–æ—Å–ª–µ:** 50 –ø—Ä–æ–¥—É–∫—Ç–æ–≤ ‚Üí 1-2 –∑–∞–ø—Ä–æ—Å–∞ –∫ –ë–î (VIEW –∏–ª–∏ batch)
- **–£–ª—É—á—à–µ–Ω–∏–µ:** ~96% —Å–æ–∫—Ä–∞—â–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤

---

## üîÑ –ö–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏—è —Å –¥—Ä—É–≥–∏–º–∏ –∞–≥–µ–Ω—Ç–∞–º–∏

**–ù–µ –ø–µ—Ä–µ—Å–µ–∫–∞–µ—Ç—Å—è —Å Agent 1:**
- Agent 1 —Ä–∞–±–æ—Ç–∞–µ—Ç —Å cleanup –∏ –∫–æ–Ω—Å–æ–ª–∏–¥–∞—Ü–∏–µ–π
- Agent 3 —Ä–∞–±–æ—Ç–∞–µ—Ç —Å –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å—é –ë–î
- –ú–æ–≥—É—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ

**–ü–µ—Ä–µ—Å–µ–∫–∞–µ—Ç—Å—è —Å Agent 2:**
- Agent 2 —Ä–∞–∑–±–∏–≤–∞–µ—Ç `profile.py`, `workers.py` –Ω–∞ –º–æ–¥—É–ª–∏
- Agent 3 –∑–∞–º–µ–Ω—è–µ—Ç `asyncio.to_thread` –≤ —ç—Ç–∏—Ö –∂–µ —Ñ–∞–π–ª–∞—Ö
- ‚ö†Ô∏è **–†–µ—à–µ–Ω–∏–µ:** Agent 3 –º–æ–∂–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –ü–û–°–õ–ï Agent 2 (–∑–∞–º–µ–Ω–∏—Ç—å –≤ —É–∂–µ —Ä–∞–∑–±–∏—Ç—ã—Ö –º–æ–¥—É–ª—è—Ö) –ò–õ–ò –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ (–Ω–æ –Ω—É–∂–Ω–æ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è)

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** Agent 3 –¥–æ–ª–∂–µ–Ω —Ä–∞–±–æ—Ç–∞—Ç—å –ü–û–°–õ–ï Agent 2 (—á—Ç–æ–±—ã –∑–∞–º–µ–Ω—è—Ç—å `asyncio.to_thread` –≤ —É–∂–µ —Ä–∞–∑–±–∏—Ç—ã—Ö –º–æ–¥—É–ª—è—Ö), –Ω–æ –º–æ–∂–µ—Ç –Ω–∞—á–∞—Ç—å —Å N+1 queries –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ.

**–ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Ä–∞–±–æ—Ç—ã:**
1. Agent 3 –Ω–∞—á–∏–Ω–∞–µ—Ç —Å N+1 queries (–Ω–µ –ø–µ—Ä–µ—Å–µ–∫–∞–µ—Ç—Å—è —Å Agent 2) ‚Äî 2 –¥–Ω—è
2. Agent 2 —Ä–∞–∑–±–∏–≤–∞–µ—Ç –º–æ–Ω–æ–ª–∏—Ç—ã (2-3 –¥–Ω—è)
3. Agent 3 –∑–∞–º–µ–Ω—è–µ—Ç `asyncio.to_thread` –≤ —Ä–∞–∑–±–∏—Ç—ã—Ö –º–æ–¥—É–ª—è—Ö ‚Äî 2 –¥–Ω—è
4. Agent 3 –º–∏–≥—Ä–∏—Ä—É–µ—Ç –Ω–∞ domains ‚Äî 1 –¥–µ–Ω—å

---

## üìù –ü—Ä–∏–º–µ—á–∞–Ω–∏—è

- N+1 queries ‚Äî –∫—Ä–∏—Ç–∏—á–Ω–æ –¥–ª—è –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è. –î–æ–ª–∂–Ω–æ –±—ã—Ç—å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –î–û —É–≤–µ–ª–∏—á–µ–Ω–∏—è –∫–∞—Ç–∞–ª–æ–≥–∞ –¥–æ 50+ –ø—Ä–æ–¥—É–∫—Ç–æ–≤.
- VIEW `products_with_stock_summary` ‚Äî –ø—Ä–µ–¥–ø–æ—á—Ç–∏—Ç–µ–ª—å–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ (–±—ã—Å—Ç—Ä–µ–µ, –ø—Ä–∞–≤–∏–ª—å–Ω–µ–µ —Å —Ç–æ—á–∫–∏ –∑—Ä–µ–Ω–∏—è SQL).
- –ó–∞–º–µ–Ω–∞ `asyncio.to_thread` —É–ª—É—á—à–∏—Ç –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (–º–µ–Ω—å—à–µ overhead).
- –ú–∏–≥—Ä–∞—Ü–∏—è –Ω–∞ domains —É–ª—É—á—à–∏—Ç –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º–æ—Å—Ç—å (–µ–¥–∏–Ω–∞—è –∞–±—Å—Ç—Ä–∞–∫—Ü–∏—è).
- –í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω—ã –Ω–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (50+ –ø—Ä–æ–¥—É–∫—Ç–æ–≤).

---

## üéØ –¶–µ–ª–µ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

| –ú–µ—Ç—Ä–∏–∫–∞ | –î–æ | –ü–æ—Å–ª–µ | –£–ª—É—á—à–µ–Ω–∏–µ |
|---------|-----|-------|-----------|
| **–ó–∞–ø—Ä–æ—Å–æ–≤ –∫ –ë–î (50 –ø—Ä–æ–¥—É–∫—Ç–æ–≤)** | 50+ (N+1) | 1-2 (VIEW/batch) | ‚úÖ ~96% |
| **Overhead –æ—Ç to_thread** | 50+ –º–µ—Å—Ç | 0 | ‚úÖ 100% |
| **–ü—Ä—è–º—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤** | 50+ –º–µ—Å—Ç | <10 (—Ç–æ–ª—å–∫–æ –≥–¥–µ domains –Ω–µ—Ç –º–µ—Ç–æ–¥–∞) | ‚úÖ ~80% |
| **–í—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞ –∫–∞—Ç–∞–ª–æ–≥–∞** | ~2-3s (50 –ø—Ä–æ–¥—É–∫—Ç–æ–≤) | ~200-300ms | ‚úÖ ~90% |

**–ò—Ç–æ–≥–æ–≤—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:** –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ –¥–ª—è –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è, N+1 queries –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã, async –ø–∞—Ç—Ç–µ—Ä–Ω—ã —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω—ã.
