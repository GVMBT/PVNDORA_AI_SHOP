# üöÄ –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞ –∞–≥–µ–Ω—Ç–∞–º

**–î–∞—Ç–∞:** 2026-01-27  
**–ü—Ä–æ–µ–∫—Ç:** PVNDORA AI Marketplace  
**–°—Ç–∞—Ç—É—Å:** –ì–æ—Ç–æ–≤–æ –∫ –Ω–∞—á–∞–ª—É —Ä–∞–±–æ—Ç—ã

---

## üìã –û–±—â–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç

**–¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏:**
- Python 3.12 + FastAPI (Vercel Serverless)
- Supabase PostgreSQL (NO ORM, –ø—Ä—è–º–æ–π SQL —á–µ—Ä–µ–∑ `supabase-py`)
- OpenRouter API + LangGraph (AI –∞–≥–µ–Ω—Ç)
- Telegram Bot API (aiogram)
- Upstash QStash (async workers)
- Upstash Redis (–∫—ç—à)

**–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è:**
- ‚úÖ Single entry point: `api/index.py` (Vercel limit: 12 functions)
- ‚úÖ `supabase-py` –∏–º–µ–µ—Ç async –º–µ—Ç–æ–¥—ã: `await client.table().select().execute()`
- ‚úÖ QStash –¥–ª—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö async –æ–ø–µ—Ä–∞—Ü–∏–π
- ‚úÖ –ù–ï –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Supabase Triggers –¥–ª—è –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏

**–í–∞–∂–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:**
- –í –ø—Ä–æ–µ–∫—Ç–µ **—Ç–æ–ª—å–∫–æ 2 –≤–∞–ª—é—Ç—ã –¥–ª—è –±–∞–ª–∞–Ω—Å–æ–≤**: RUB –∏ USD
- –ë–∞–ª–∞–Ω—Å –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –ø–æ `language_code`: ru/be/kk ‚Üí RUB, –æ—Å—Ç–∞–ª—å–Ω—ã–µ ‚Üí USD
- EUR –∏ –¥—Ä—É–≥–∏–µ –≤–∞–ª—é—Ç—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ü–µ–Ω —Ç–æ–≤–∞—Ä–æ–≤, –ù–ï –¥–ª—è –±–∞–ª–∞–Ω—Å–æ–≤

---

## ü§ñ Agent 1: Cleanup & Consolidation

**–§–∞–π–ª –ø–ª–∞–Ω–∞:** [`REFACTORING_PLAN_AGENT_1_CLEANUP.md`](./REFACTORING_PLAN_AGENT_1_CLEANUP.md)

**–ù–∞—á–∞–ª—å–Ω–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è:**
```
–ò–∑—É—á–∏ REFACTORING_PLAN_AGENT_1_CLEANUP.md –∏ –Ω–∞—á–Ω–∏ —Ä–∞–±–æ—Ç—É —Å Phase 0.

–¢–≤–æ–π –ø–ª–∞–Ω:
1. Phase 0 (–ö–†–ò–¢–ò–ß–ù–û, –ø–µ—Ä–≤—ã–π): –ö–æ–Ω—Å–æ–ª–∏–¥–∞—Ü–∏—è –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–π
   - –°–æ–∑–¥–∞—Ç—å core/services/telegram_messaging.py (–µ–¥–∏–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π)
   - –°–æ–∑–¥–∞—Ç—å CurrencyService.convert_balance() (RUB‚ÜîUSD –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è)
   
2. Phase 1: Cleanup
   - –£–¥–∞–ª–∏—Ç—å deprecated –∫–æ–¥
   - –£–±—Ä–∞—Ç—å unused imports
   - –û–±–Ω–æ–≤–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é

–í–ê–ñ–ù–û: Phase 0 –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∑–∞–≤–µ—Ä—à—ë–Ω –î–û —Ç–æ–≥–æ, –∫–∞–∫ Agent 2 –Ω–∞—á–Ω—ë—Ç Phase 2.
```

**–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:** –ù–µ—Ç (–Ω–∞—á–∏–Ω–∞–π –ø–µ—Ä–≤—ã–º)

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üî¥ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π

**–û—Ü–µ–Ω–∫–∞:** 2-4 –¥–Ω—è

---

## üî® Agent 2: Monolith Splitting

**–§–∞–π–ª –ø–ª–∞–Ω–∞:** [`REFACTORING_PLAN_AGENT_2_SPLITTING.md`](./REFACTORING_PLAN_AGENT_2_SPLITTING.md)

**–ù–∞—á–∞–ª—å–Ω–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è:**
```
–ò–∑—É—á–∏ REFACTORING_PLAN_AGENT_2_SPLITTING.md.

‚ö†Ô∏è –í–ê–ñ–ù–û: –ù–ï –Ω–∞—á–∏–Ω–∞–π Phase 2 –∏ Phase 3, –ø–æ–∫–∞ Agent 1 –Ω–µ –∑–∞–≤–µ—Ä—à–∏—Ç Phase 0!

–¢–≤–æ–π –ø–ª–∞–Ω:
1. Phase 2: Split Notifications & Workers (–ó–ê–í–ò–°–ò–¢ –û–¢ Phase 0 Agent 1)
   - –†–∞–∑–±–∏—Ç—å core/services/notifications.py (1281 —Å—Ç—Ä–æ–∫–∞)
   - –†–∞–∑–±–∏—Ç—å core/routers/workers.py (1271 —Å—Ç—Ä–æ–∫–∞)
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å telegram_messaging.py (—Å–æ–∑–¥–∞—Å—Ç Agent 1)

2. Phase 3: Split Profile Router (–ó–ê–í–ò–°–ò–¢ –û–¢ Phase 0 Agent 1)
   - –†–∞–∑–±–∏—Ç—å core/routers/webapp/profile.py (1145 —Å—Ç—Ä–æ–∫)
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å CurrencyService.convert_balance() (—Å–æ–∑–¥–∞—Å—Ç Agent 1)

3. Phase 4: Split Orders Router
   - –†–∞–∑–±–∏—Ç—å core/routers/webapp/orders.py (1110 —Å—Ç—Ä–æ–∫)

–ú–æ–∂–µ—à—å –Ω–∞—á–∞—Ç—å —Å Phase 4, –µ—Å–ª–∏ Phase 0 Agent 1 –µ—â—ë –Ω–µ –∑–∞–≤–µ—Ä—à—ë–Ω.
```

**–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:** 
- Phase 2 –∏ Phase 3 –∑–∞–≤–∏—Å—è—Ç –æ—Ç Phase 0 Agent 1
- Phase 4 –º–æ–∂–Ω–æ –Ω–∞—á–∞—Ç—å —Å—Ä–∞–∑—É

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üî¥ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π ‚Üí üü° –í—ã—Å–æ–∫–∏–π

**–û—Ü–µ–Ω–∫–∞:** 7-10 –¥–Ω–µ–π

---

## ‚ö° Agent 3: Database & Performance Optimization

**–§–∞–π–ª –ø–ª–∞–Ω–∞:** [`REFACTORING_PLAN_AGENT_3_OPTIMIZATION.md`](./REFACTORING_PLAN_AGENT_3_OPTIMIZATION.md)

**–ù–∞—á–∞–ª—å–Ω–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è:**
```
–ò–∑—É—á–∏ REFACTORING_PLAN_AGENT_3_OPTIMIZATION.md –∏ –Ω–∞—á–Ω–∏ —Ä–∞–±–æ—Ç—É.

–¢–≤–æ–π –ø–ª–∞–Ω:
1. Phase 7: Database Query Optimization
   - –ò—Å–ø—Ä–∞–≤–∏—Ç—å N+1 queries –≤ ProductRepository (get_all, get_by_id, search)
   - –ò—Å–ø—Ä–∞–≤–∏—Ç—å N+1 queries –≤ admin/products.py, discount/catalog.py, webapp/public.py
   - –°–æ–∑–¥–∞—Ç—å VIEW products_with_stock_summary (–∏–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å batch loading)
   - –ó–∞–º–µ–Ω–∏—Ç—å asyncio.to_thread() –Ω–∞ async domains (20+ –º–µ—Å—Ç –≤ profile.py)

–í–ê–ñ–ù–û: –ú–æ–∂–µ—à—å —Ä–∞–±–æ—Ç–∞—Ç—å –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ —Å Agent 1 –∏ Agent 2, —Ñ–∞–π–ª—ã –Ω–µ –ø–µ—Ä–µ—Å–µ–∫–∞—é—Ç—Å—è.
```

**–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:** –ù–µ—Ç (–º–æ–∂–µ—à—å –Ω–∞—á–∞—Ç—å —Å—Ä–∞–∑—É)

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üî¥ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π (–¥–ª—è –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è)

**–û—Ü–µ–Ω–∫–∞:** 5-7 –¥–Ω–µ–π

---

## üìù –û–±—â–∏–µ –ø—Ä–∞–≤–∏–ª–∞ –¥–ª—è –≤—Å–µ—Ö –∞–≥–µ–Ω—Ç–æ–≤

### –ü–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º —Ä–∞–±–æ—Ç—ã:
1. ‚úÖ –ü—Ä–æ—á–∏—Ç–∞–π —Å–≤–æ–π –ø–ª–∞–Ω –ø–æ–ª–Ω–æ—Å—Ç—å—é (REFACTORING_PLAN_AGENT_X.md)
2. ‚úÖ –ü—Ä–æ—á–∏—Ç–∞–π `.cursor/rules/architecture.mdc` (–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞)
3. ‚úÖ –ü—Ä–æ—á–∏—Ç–∞–π `.cursor/rules/development-workflow.mdc` (–ø—Ä–∞–≤–∏–ª–∞ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏)
4. ‚úÖ –ò–∑—É—á–∏ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥ –≤ —Ñ–∞–π–ª–∞—Ö, –∫–æ—Ç–æ—Ä—ã–µ –±—É–¥–µ—à—å –∏–∑–º–µ–Ω—è—Ç—å

### –í–æ –≤—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã:
1. ‚úÖ –°–ª–µ–¥—É–π checklist –∏–∑ —Å–≤–æ–µ–≥–æ –ø–ª–∞–Ω–∞
2. ‚úÖ –î–µ–ª–∞–π commits —Å –ø–æ–Ω—è—Ç–Ω—ã–º–∏ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏ (—Å–º. –ø–ª–∞–Ω)
3. ‚úÖ –ü—Ä–æ–≤–µ—Ä—è–π linter –ø–µ—Ä–µ–¥ commit (`ruff check .` –¥–ª—è Python)
4. ‚úÖ –û–±–Ω–æ–≤–ª—è–π checklist –≤ —Å–≤–æ—ë–º –ø–ª–∞–Ω–µ (–æ—Ç–º–µ—á–∞–π –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –ø—É–Ω–∫—Ç—ã)

### –í–∞–∂–Ω—ã–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è:
- ‚ùå –ù–ï —Å–æ–∑–¥–∞–≤–∞–π –Ω–æ–≤—ã–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –±–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö (—Å–º. `supabase/migrations/`)
- ‚ùå –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π ORM (SQLAlchemy/Django) ‚Äî —Ç–æ–ª—å–∫–æ –ø—Ä—è–º–æ–π SQL —á–µ—Ä–µ–∑ `supabase-py`
- ‚ùå –ù–ï —Å–æ–∑–¥–∞–≤–∞–π –Ω–æ–≤—ã–µ serverless —Ñ—É–Ω–∫—Ü–∏–∏ ‚Äî –∏—Å–ø–æ–ª—å–∑—É–π single entry point `api/index.py`
- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–π async/await –≤–µ–∑–¥–µ (–æ—Å–æ–±–µ–Ω–Ω–æ –¥–ª—è `supabase-py`)
- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–π `Decimal` –¥–ª—è —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö –≤—ã—á–∏—Å–ª–µ–Ω–∏–π (–Ω–µ `float`)
- ‚úÖ –ë–∞–ª–∞–Ω—Å—ã —Ç–æ–ª—å–∫–æ RUB –∏ USD (–Ω–µ EUR –∏ –¥—Ä—É–≥–∏–µ)

### –ö–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏—è –º–µ–∂–¥—É –∞–≥–µ–Ω—Ç–∞–º–∏:
- **Agent 1 ‚Üí Agent 2:** Agent 1 —Å–æ–∑–¥–∞—ë—Ç `telegram_messaging.py` –∏ `convert_balance()` –≤ Phase 0
- **Agent 2 –∂–¥—ë—Ç Phase 0 Agent 1** –ø–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º Phase 2 –∏ Phase 3
- **Agent 3 —Ä–∞–±–æ—Ç–∞–µ—Ç –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ** (–Ω–µ –ø–µ—Ä–µ—Å–µ–∫–∞–µ—Ç—Å—è –ø–æ —Ñ–∞–π–ª–∞–º)

### –ï—Å–ª–∏ –Ω–∞—à–µ–ª –ø—Ä–æ–±–ª–µ–º—É:
1. –ó–∞—Ñ–∏–∫—Å–∏—Ä—É–π –µ—ë –≤ —Å–≤–æ—ë–º –ø–ª–∞–Ω–µ (–¥–æ–±–∞–≤—å —Å–µ–∫—Ü–∏—é "–ù–∞–π–¥–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã")
2. –ï—Å–ª–∏ –±–ª–æ–∫–∏—Ä—É–µ—Ç —Ä–∞–±–æ—Ç—É ‚Äî —Å–æ–æ–±—â–∏ —Å—Ä–∞–∑—É
3. –ï—Å–ª–∏ –º–æ–∂–Ω–æ –æ–±–æ–π—Ç–∏ ‚Äî –ø—Ä–æ–¥–æ–ª–∂–∞–π —Ä–∞–±–æ—Ç—É, –∑–∞—Ñ–∏–∫—Å–∏—Ä—É–π –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ —Å–ø—Ä–∏–Ω—Ç–∞

---

## ‚úÖ –ß–µ–∫–ª–∏—Å—Ç –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –∫ –Ω–∞—á–∞–ª—É

–î–ª—è –∫–∞–∂–¥–æ–≥–æ –∞–≥–µ–Ω—Ç–∞ —É–±–µ–¥–∏—Å—å:
- [ ] –ü—Ä–æ—á–∏—Ç–∞–Ω —Å–≤–æ–π –ø–ª–∞–Ω (REFACTORING_PLAN_AGENT_X.md)
- [ ] –ü—Ä–æ—á–∏—Ç–∞–Ω—ã –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞ (`.cursor/rules/architecture.mdc`)
- [ ] –ü—Ä–æ—á–∏—Ç–∞–Ω—ã –ø—Ä–∞–≤–∏–ª–∞ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ (`.cursor/rules/development-workflow.mdc`)
- [ ] –ò–∑—É—á–µ–Ω —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥ (—Ñ–∞–π–ª—ã –∏–∑ –ø–ª–∞–Ω–∞)
- [ ] –ü–æ–Ω—è—Ç–Ω—ã –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –¥—Ä—É–≥–∏—Ö –∞–≥–µ–Ω—Ç–æ–≤ (–µ—Å–ª–∏ –µ—Å—Ç—å)
- [ ] –ì–æ—Ç–æ–≤ –Ω–∞—á–∞—Ç—å —Å –ø–µ—Ä–≤–æ–≥–æ –ø—É–Ω–∫—Ç–∞ checklist

---

## üìö –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã

**–û—Å–Ω–æ–≤–Ω–æ–π –ø–ª–∞–Ω:** [`REFACTORING_PLAN.md`](./REFACTORING_PLAN.md)  
**–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø—Ä–æ–µ–∫—Ç–∞:** –°–º. `docs/`  
**–ü—Ä–∞–≤–∏–ª–∞ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã:** `.cursor/rules/architecture.mdc`  
**–ü—Ä–∞–≤–∏–ª–∞ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏:** `.cursor/rules/development-workflow.mdc`  

---

**–£–¥–∞—á–∏ –≤ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–µ! üöÄ**
