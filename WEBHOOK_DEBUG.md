# Диагностика вебхука Telegram

## Шаги для проверки

### 1. Проверка статуса вебхука через Telegram API

Выполните запрос (замените `<ВАШ_ТОКЕН>` на токен бота):

```
https://api.telegram.org/bot<ВАШ_ТОКЕН>/getWebhookInfo
```

**Ожидаемый результат:**
```json
{
  "ok": true,
  "result": {
    "url": "https://pvndora-ai-shop.vercel.app/webhook/telegram",
    "has_custom_certificate": false,
    "pending_update_count": 0
  }
}
```

**Если есть ошибки:**
- Проверьте поле `last_error_message` - там будет описание проблемы
- Проверьте `last_error_date` - когда произошла последняя ошибка

### 2. Проверка доступности эндпоинта

Откройте в браузере:
- Health check: `https://pvndora-ai-shop.vercel.app/api/health`
- Webhook test: `https://pvndora-ai-shop.vercel.app/api/webhook/test`

Оба должны вернуть JSON ответ.

### 3. Проверка логов Vercel

1. Зайдите в Vercel Dashboard
2. Откройте ваш проект
3. Перейдите в раздел "Logs" или "Functions"
4. Найдите логи для `/api/index.py`
5. Отправьте сообщение боту и проверьте логи на наличие ошибок

### 4. Локальная проверка скриптом

Запустите скрипт диагностики:
```bash
python scripts/check_webhook.py
```

Убедитесь, что установлены переменные окружения:
- `TELEGRAM_TOKEN`
- `TELEGRAM_WEBHOOK_URL` (опционально)

### 5. Тест отправки сообщения

1. Откройте бота в Telegram
2. Отправьте команду `/start`
3. Проверьте логи Vercel на наличие запросов к `/webhook/telegram`
4. Проверьте, есть ли ошибки в логах

## Частые проблемы

### Проблема: Вебхук установлен, но бот не отвечает

**Возможные причины:**
1. **Ошибки в коде обработки** - проверьте логи Vercel
2. **Проблемы с базой данных** - проверьте подключение к Supabase
3. **Ошибки в middlewares** - проверьте логи на наличие исключений
4. **Таймаут функции** - проверьте, что обработка завершается быстро

**Решение:**
- Проверьте логи Vercel после отправки сообщения
- Убедитесь, что все переменные окружения установлены
- Проверьте, что Supabase доступен и RLS политики настроены

### Проблема: "Bot not configured"

**Причина:** `TELEGRAM_TOKEN` не установлен или пустой

**Решение:**
- Проверьте переменные окружения в Vercel
- Убедитесь, что токен правильный
- Перезапустите деплой после изменения переменных

### Проблема: "Invalid update" или ошибки валидации

**Причина:** Telegram отправляет обновление в неожиданном формате

**Решение:**
- Проверьте логи - там будет детальная информация об ошибке
- Убедитесь, что используется последняя версия aiogram

### Проблема: Таймаут при обработке

**Причина:** Обработка сообщения занимает слишком много времени

**Решение:**
- Увеличьте `maxDuration` в `vercel.json` (максимум 60 секунд для Hobby)
- Оптимизируйте запросы к базе данных
- Используйте асинхронную обработку для долгих операций

## Проверка через curl

### Тест health check:
```bash
curl https://pvndora-ai-shop.vercel.app/api/health
```

### Тест webhook endpoint (симуляция обновления):
```bash
curl -X POST https://pvndora-ai-shop.vercel.app/webhook/telegram \
  -H "Content-Type: application/json" \
  -d '{
    "update_id": 123456789,
    "message": {
      "message_id": 1,
      "from": {
        "id": 123456,
        "is_bot": false,
        "first_name": "Test",
        "username": "testuser"
      },
      "chat": {
        "id": 123456,
        "type": "private"
      },
      "date": 1234567890,
      "text": "/start"
    }
  }'
```

**Внимание:** Это вызовет ошибку валидации, но покажет, что эндпоинт работает.

## Контакты для отладки

Если проблема не решается:
1. Проверьте все логи Vercel
2. Проверьте статус вебхука через Telegram API
3. Убедитесь, что все переменные окружения установлены
4. Проверьте, что приложение успешно задеплоено

