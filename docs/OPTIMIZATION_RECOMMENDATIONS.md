# –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ (–Ω–∞ –æ—Å–Ω–æ–≤–µ –∞–Ω–∞–ª–∏–∑–∞ –ª–æ–≥–æ–≤)

**–î–∞—Ç–∞ –∞–Ω–∞–ª–∏–∑–∞:** 2026-01-12  
**–ò—Å—Ç–æ—á–Ω–∏–∫:** –õ–æ–≥–∏ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –¥–µ–ø–ª–æ–π–º–µ–Ω—Ç–∞ (`pvndora-ai-shop-jyhimrpr5`)

## –ö—Ä–∏—Ç–∏—á–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### 1. –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ PATCH –∑–∞–ø—Ä–æ—Å—ã –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

**–ü—Ä–æ–±–ª–µ–º–∞:**  
–í –ª–æ–≥–∞—Ö –≤–∏–¥–Ω–æ –º–Ω–æ–∂–µ—Å—Ç–≤–æ `PATCH /users?telegram_id=eq.339469894` –∑–∞–ø—Ä–æ—Å–æ–≤ –Ω–∞ –∫–∞–∂–¥—ã–π API –≤—ã–∑–æ–≤. –ù–∞–ø—Ä–∏–º–µ—Ä, –≤ `/api/webapp/referral/network` –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è **3 –æ–¥–∏–Ω–∞–∫–æ–≤—ã—Ö PATCH –∑–∞–ø—Ä–æ—Å–∞ –ø–æ–¥—Ä—è–¥**.

**–ü—Ä–∏–º–µ—Ä –∏–∑ –ª–æ–≥–æ–≤:**
```
12:31:00.13  PATCH users?telegram_id=eq.339469894
12:31:00.14  PATCH users?telegram_id=eq.339469894
12:31:00.14  PATCH users?telegram_id=eq.339469894
```

**–†–µ—à–µ–Ω–∏–µ:**
- –î–æ–±–∞–≤–∏—Ç—å FastAPI middleware –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è **–æ–¥–∏–Ω —Ä–∞–∑** –Ω–∞ –≤–µ—Å—å request lifecycle
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å debounce/throttling (–Ω–∞–ø—Ä–∏–º–µ—Ä, –æ–±–Ω–æ–≤–ª—è—Ç—å –Ω–µ —á–∞—â–µ 1 —Ä–∞–∑–∞ –≤ –º–∏–Ω—É—Ç—É —á–µ—Ä–µ–∑ Redis)
- –ò–ª–∏ —Å–¥–µ–ª–∞—Ç—å –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ (fire-and-forget) —á—Ç–æ–±—ã –Ω–µ –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –æ—Å–Ω–æ–≤–Ω–æ–π –∑–∞–ø—Ä–æ—Å

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üî¥ –í—ã—Å–æ–∫–∏–π  
**–û–∂–∏–¥–∞–µ–º—ã–π —ç—Ñ—Ñ–µ–∫—Ç:** –°–Ω–∏–∂–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ DB –∑–∞–ø—Ä–æ—Å–æ–≤ –Ω–∞ 60-70%

---

### 2. –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ GET –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ users –≤ `/api/webapp/referral/network`

**–ü—Ä–æ–±–ª–µ–º–∞:**  
–≠–Ω–¥–ø–æ–∏–Ω—Ç `/api/webapp/referral/network` –¥–µ–ª–∞–µ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ GET –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ `users` —Ç–∞–±–ª–∏—Ü–µ:
- 3 GET –∑–∞–ø—Ä–æ—Å–∞ –ø–æ–¥—Ä—è–¥: `GET users?select=*&telegram_id=eq.339469894`
- –ó–∞—Ç–µ–º –µ—â–µ `GET users?select=id&referrer_id=eq.2a6c35f0...`

**–ü—Ä–∏–º–µ—Ä –∏–∑ –ª–æ–≥–æ–≤:**
```
12:31:00.18  GET users?select=*&telegram_id=eq.339469894
12:31:00.19  GET users?select=*&telegram_id=eq.339469894
12:31:00.20  GET users?select=*&telegram_id=eq.339469894
```

**–†–µ—à–µ–Ω–∏–µ:**
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ user –¥–∞–Ω–Ω—ã—Ö –≤ Redis (TTL 1-5 –º–∏–Ω—É—Ç)
- –£–±—Ä–∞—Ç—å –¥—É–±–ª–∏—Ä—É—é—â–∏–µ—Å—è –∑–∞–ø—Ä–æ—Å—ã –≤–Ω—É—Ç—Ä–∏ –æ–¥–Ω–æ–≥–æ —ç–Ω–¥–ø–æ–∏–Ω—Ç–∞
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `asyncio.gather()` –¥–ª—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –≥–¥–µ –≤–æ–∑–º–æ–∂–Ω–æ

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üî¥ –í—ã—Å–æ–∫–∏–π  
**–û–∂–∏–¥–∞–µ–º—ã–π —ç—Ñ—Ñ–µ–∫—Ç:** –°–Ω–∏–∂–µ–Ω–∏–µ DB –∑–∞–ø—Ä–æ—Å–æ–≤ –Ω–∞ 40-50% –¥–ª—è —ç—Ç–æ–≥–æ —ç–Ω–¥–ø–æ–∏–Ω—Ç–∞

---

### 3. N+1 –ø—Ä–æ–±–ª–µ–º–∞ –≤ `/api/webapp/referral/network` –¥–ª—è –ø–æ–¥—Å—á–µ—Ç–∞ –∑–∞–∫–∞–∑–æ–≤

**–ü—Ä–æ–±–ª–µ–º–∞:**  
–î–ª—è –∫–∞–∂–¥–æ–≥–æ —Ä–µ—Ñ–µ—Ä–∞–ª–∞ –¥–µ–ª–∞–µ—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω—ã–π –∑–∞–ø—Ä–æ—Å –¥–ª—è –ø–æ–¥—Å—á–µ—Ç–∞ –∑–∞–∫–∞–∑–æ–≤:
```python
orders_result = await db.client.table("orders").select(
    "id", count="exact"
).eq("user_id", ref_id).in_("status", ["delivered"]).execute()
```

–≠—Ç–æ —Å–æ–∑–¥–∞–µ—Ç N+1 –∑–∞–ø—Ä–æ—Å–æ–≤ (1 –¥–ª—è —Å–ø–∏—Å–∫–∞ —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤ + N –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ä–µ—Ñ–µ—Ä–∞–ª–∞).

**–†–µ—à–µ–Ω–∏–µ:**
- –°–æ–∑–¥–∞—Ç—å SQL VIEW –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∞–≥—Ä–µ–≥–∞—Ü–∏—é —Å `JOIN`
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å batch –∑–∞–ø—Ä–æ—Å —Å `GROUP BY user_id` –¥–ª—è –≤—Å–µ—Ö —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤ —Å—Ä–∞–∑—É
- –ü—Ä–∏–º–µ—Ä: `SELECT user_id, COUNT(*) FROM orders WHERE user_id IN (...) GROUP BY user_id`

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üü° –°—Ä–µ–¥–Ω–∏–π  
**–û–∂–∏–¥–∞–µ–º—ã–π —ç—Ñ—Ñ–µ–∫—Ç:** –°–Ω–∏–∂–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤ —Å N+1 –¥–æ 1-2 –∑–∞–ø—Ä–æ—Å–æ–≤

---

## –°—Ä–µ–¥–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã

### 4. –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –∫ Redis (Upstash)

**–ü—Ä–æ–±–ª–µ–º–∞:**  
–í –ª–æ–≥–∞—Ö –≤–∏–¥–Ω–æ –º–Ω–æ–∂–µ—Å—Ç–≤–æ `POST https://grown-husky-42729.upstash.io` –∑–∞–ø—Ä–æ—Å–æ–≤ –¥–ª—è –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è. –ö–∞–∂–¥—ã–π –∑–∞–ø—Ä–æ—Å - —ç—Ç–æ –æ—Ç–¥–µ–ª—å–Ω—ã–π HTTP –∑–∞–ø—Ä–æ—Å.

**–ü—Ä–∏–º–µ—Ä –∏–∑ –ª–æ–≥–æ–≤:**
```
12:30:55.56  POST upstash.io
12:30:55.56  POST upstash.io
12:30:55.56  POST upstash.io
12:30:55.62  POST upstash.io
```

**–†–µ—à–µ–Ω–∏–µ:**
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å pipeline/batch –æ–ø–µ—Ä–∞—Ü–∏–∏ –¥–ª—è Redis –≥–¥–µ –≤–æ–∑–º–æ–∂–Ω–æ
- –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –æ–ø–µ—Ä–∞—Ü–∏–π –≤ –æ–¥–∏–Ω –∑–∞–ø—Ä–æ—Å (–Ω–∞–ø—Ä–∏–º–µ—Ä, `MGET`, `MSET`)
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ª–æ–∫–∞–ª—å–Ω—ã–π in-memory –∫—ç—à (–Ω–∞–ø—Ä–∏–º–µ—Ä, `functools.lru_cache`) –¥–ª—è —á–∞—Å—Ç–æ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º—ã—Ö –¥–∞–Ω–Ω—ã—Ö (–Ω–∞–ø—Ä–∏–º–µ—Ä, `referral_settings`)

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üü° –°—Ä–µ–¥–Ω–∏–π  
**–û–∂–∏–¥–∞–µ–º—ã–π —ç—Ñ—Ñ–µ–∫—Ç:** –°–Ω–∏–∂–µ–Ω–∏–µ Redis –∑–∞–ø—Ä–æ—Å–æ–≤ –Ω–∞ 30-40%

---

### 5. –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ GET –∑–∞–ø—Ä–æ—Å—ã –∫ users –≤ `/api/webapp/profile`

**–ü—Ä–æ–±–ª–µ–º–∞:**  
–≠–Ω–¥–ø–æ–∏–Ω—Ç `/api/webapp/profile` –¥–µ–ª–∞–µ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ `users`:
1. `GET users?telegram_id=eq.339469894` (–≤ –Ω–∞—á–∞–ª–µ)
2. `GET users?telegram_id=eq.339469894` (–≤ `CurrencyFormatter.create()`)
3. `GET users?telegram_id=eq.339469894` (–≤ –∫–æ–Ω—Ü–µ –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)

**–†–µ—à–µ–Ω–∏–µ:**
- –ü–µ—Ä–µ–¥–∞–≤–∞—Ç—å `db_user` –æ–±—ä–µ–∫—Ç –≤ `CurrencyFormatter.create()` –≤–º–µ—Å—Ç–æ `user_telegram_id`
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ user –¥–∞–Ω–Ω—ã—Ö –Ω–∞ —É—Ä–æ–≤–Ω–µ request context

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üü° –°—Ä–µ–¥–Ω–∏–π  
**–û–∂–∏–¥–∞–µ–º—ã–π —ç—Ñ—Ñ–µ–∫—Ç:** –°–Ω–∏–∂–µ–Ω–∏–µ DB –∑–∞–ø—Ä–æ—Å–æ–≤ –Ω–∞ 30% –¥–ª—è —ç—Ç–æ–≥–æ —ç–Ω–¥–ø–æ–∏–Ω—Ç–∞

---

### 6. –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –≤ webhook `/api/webhook/crystalpay`

**–ü—Ä–æ–±–ª–µ–º–∞:**  
Webhook –¥–µ–ª–∞–µ—Ç –º–Ω–æ–∂–µ—Å—Ç–≤–æ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤:
1. `GET orders?payment_id=eq...`
2. `GET orders?id=eq...` (–ø–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞)
3. `GET order_items?order_id=eq...` (–ø–æ–ª—É—á–µ–Ω–∏–µ —Ç–∏–ø–æ–≤ –¥–æ—Å—Ç–∞–≤–∫–∏)
4. `GET stock_items?...`
5. `PATCH orders?id=eq...` (2 —Ä–∞–∑–∞)
6. `GET orders?...` (–ø–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π)
7. `GET order_items?...` (–ø–æ–ª—É—á–µ–Ω–∏–µ –Ω–∞–∑–≤–∞–Ω–∏–π –ø—Ä–æ–¥—É–∫—Ç–æ–≤)
8. `GET users?...` (–ø–æ–ª—É—á–µ–Ω–∏–µ –∞–¥–º–∏–Ω–æ–≤)
9. `GET orders?...` (–µ—â–µ —Ä–∞–∑ –¥–ª—è —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤)
10. –ò —Ç.–¥.

**–†–µ—à–µ–Ω–∏–µ:**
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `asyncio.gather()` –¥–ª—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –≥–¥–µ –≤–æ–∑–º–æ–∂–Ω–æ
- –û–±—ä–µ–¥–∏–Ω–∏—Ç—å –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ –∑–∞–ø—Ä–æ—Å—ã –≤ –æ–¥–∏–Ω (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å JOIN –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è order_items –≤–º–µ—Å—Ç–µ —Å orders)
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å batch –∑–∞–ø—Ä–æ—Å—ã –≥–¥–µ –≤–æ–∑–º–æ–∂–Ω–æ

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üü° –°—Ä–µ–¥–Ω–∏–π  
**–û–∂–∏–¥–∞–µ–º—ã–π —ç—Ñ—Ñ–µ–∫—Ç:** –°–Ω–∏–∂–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ webhook –Ω–∞ 40-50%

---

## –ú–∞–ª—ã–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

### 7. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–±–º–µ–Ω–Ω—ã—Ö –∫—É—Ä—Å–æ–≤ –≤–∞–ª—é—Ç

**–ü—Ä–æ–±–ª–µ–º–∞:**  
–í –ª–æ–≥–∞—Ö –≤–∏–¥–Ω–æ INFO-—É—Ä–æ–≤–µ–Ω—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ –∫—É—Ä—Å–∞ –≤–∞–ª—é—Ç:
```
CurrencyFormatter: got exchange_rate=79.08 for RUB
```

**–†–µ—à–µ–Ω–∏–µ:**
- –ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –≤ DEBUG —É—Ä–æ–≤–µ–Ω—å (—É–∂–µ —Å–¥–µ–ª–∞–Ω–æ —á–∞—Å—Ç–∏—á–Ω–æ)
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å structured logging –¥–ª—è –ª—É—á—à–µ–π —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üü¢ –ù–∏–∑–∫–∏–π  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ß–∞—Å—Ç–∏—á–Ω–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ

---

### 8. –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ `referral_settings`

**–ü—Ä–æ–±–ª–µ–º–∞:**  
`referral_settings` –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç—Å—è –Ω–∞ –∫–∞–∂–¥—ã–π `/api/webapp/profile` –∑–∞–ø—Ä–æ—Å, –Ω–æ –¥–∞–Ω–Ω—ã–µ –º–µ–Ω—è—é—Ç—Å—è —Ä–µ–¥–∫–æ.

**–†–µ—à–µ–Ω–∏–µ:**
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Redis –∫—ç—à —Å TTL 5-10 –º–∏–Ω—É—Ç
- –ò–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å in-memory –∫—ç—à (–Ω–∞–ø—Ä–∏–º–µ—Ä, `functools.lru_cache`)

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üü¢ –ù–∏–∑–∫–∏–π  
**–û–∂–∏–¥–∞–µ–º—ã–π —ç—Ñ—Ñ–µ–∫—Ç:** –°–Ω–∏–∂–µ–Ω–∏–µ DB –∑–∞–ø—Ä–æ—Å–æ–≤ –Ω–∞ ~5%

---

## –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π –ø–æ—Ä—è–¥–æ–∫ –≤–Ω–µ–¥—Ä–µ–Ω–∏—è

1. **–®–∞–≥ 1:** Middleware –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ (–ø—Ä–æ–±–ª–µ–º–∞ #1) - –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç
2. **–®–∞–≥ 2:** –£–±—Ä–∞—Ç—å –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ GET –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ `/api/webapp/referral/network` (–ø—Ä–æ–±–ª–µ–º–∞ #2)
3. **–®–∞–≥ 3:** N+1 –ø—Ä–æ–±–ª–µ–º–∞ –≤ `/api/webapp/referral/network` (–ø—Ä–æ–±–ª–µ–º–∞ #3)
4. **–®–∞–≥ 4:** –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è webhook –∑–∞–ø—Ä–æ—Å–æ–≤ (–ø—Ä–æ–±–ª–µ–º–∞ #6)
5. **–®–∞–≥ 5:** –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è Redis –∑–∞–ø—Ä–æ—Å–æ–≤ (–ø—Ä–æ–±–ª–µ–º–∞ #4)
6. **–®–∞–≥ 6:** –ú–µ–ª–∫–∏–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ (–ø—Ä–æ–±–ª–µ–º—ã #5, #7, #8)

---

## –ú–µ—Ç—Ä–∏–∫–∏ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è

–ü–æ—Å–ª–µ –≤–Ω–µ–¥—Ä–µ–Ω–∏—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–π —Å–ª–µ–¥—É–µ—Ç –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å:

1. **–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ DB –∑–∞–ø—Ä–æ—Å–æ–≤ –Ω–∞ request:**
   - –î–æ: ~15-20 –∑–∞–ø—Ä–æ—Å–æ–≤ –Ω–∞ `/api/webapp/profile`
   - –¶–µ–ª—å: ~5-8 –∑–∞–ø—Ä–æ—Å–æ–≤

2. **–í—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞ —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤:**
   - `/api/webapp/profile`: —Ü–µ–ª—å < 300ms
   - `/api/webapp/referral/network`: —Ü–µ–ª—å < 400ms
   - `/api/webhook/crystalpay`: —Ü–µ–ª—å < 500ms

3. **–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ Redis –∑–∞–ø—Ä–æ—Å–æ–≤:**
   - –¶–µ–ª—å: —Å–Ω–∏–∂–µ–Ω–∏–µ –Ω–∞ 30-40%

4. **Database connection pool utilization:**
   - –°–ª–µ–¥–∏—Ç—å –∑–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –ø—É–ª–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π

---

## –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

1. **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Connection Pooling:**
   - –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ Supabase client –∏—Å–ø–æ–ª—å–∑—É–µ—Ç connection pooling
   - –ù–∞—Å—Ç—Ä–æ–∏—Ç—å —Ä–∞–∑–º–µ—Ä –ø—É–ª–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –Ω–∞–≥—Ä—É–∑–∫–∏

2. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –º–µ–¥–ª–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤:**
   - –î–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤ > 500ms
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å APM –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, Vercel Analytics)

3. **–ò–Ω–¥–µ–∫—Å—ã –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö:**
   - –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –µ—Å—Ç—å –∏–Ω–¥–µ–∫—Å—ã –Ω–∞ `users.telegram_id`, `orders.user_id`, `orders.payment_id`
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–æ–≤ —á–µ—Ä–µ–∑ `EXPLAIN ANALYZE`

4. **–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ —É—Ä–æ–≤–Ω–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:**
   - –†–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ in-memory –∫—ç—à–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, `cachetools`) –¥–ª—è —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å HTTP –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –ø—É–±–ª–∏—á–Ω—ã—Ö —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤ –≥–¥–µ –≤–æ–∑–º–æ–∂–Ω–æ
