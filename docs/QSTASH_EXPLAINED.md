# Что такое QStash и зачем он нужен?

## Проблема: Vercel "замораживает" функции

### Как работает Vercel Serverless

1. **Запрос приходит** → Vercel запускает функцию
2. **Функция обрабатывает** → Возвращает ответ
3. **Vercel замораживает функцию** → Все процессы останавливаются

**Проблема:** Если вы используете `BackgroundTasks` для критических операций (доставка товара, начисление бонусов), и функция заморозилась до завершения задачи - **задача теряется навсегда**.

### Пример проблемы

```python
# ❌ ПЛОХО: Может потерять задачу
@app.post("/api/webhook/payment")
async def payment_webhook(request: Request, bg_tasks: BackgroundTasks):
    # Платеж подтвержден
    order.status = "paid"
    await db.save(order)
    
    # Пытаемся доставить товар в фоне
    bg_tasks.add_task(deliver_goods, order.id)  # ⚠️ Может не выполниться!
    
    return {"ok": True}  # Vercel замораживает функцию → задача теряется
```

**Результат:** Пользователь заплатил, но товар не получил. Деньги списаны, товар не доставлен.

## Решение: QStash

### Что такое QStash?

**QStash** - это внешняя очередь сообщений от Upstash, которая:
- ✅ Гарантирует доставку задачи
- ✅ Автоматически повторяет при ошибках
- ✅ Работает вне Vercel (не замораживается)
- ✅ Имеет встроенный retry механизм

### Как это работает

```python
# ✅ ХОРОШО: Гарантированная доставка
from upstash_qstash import QStash

qstash = QStash(token=os.getenv("QSTASH_TOKEN"))

@app.post("/api/webhook/payment")
async def payment_webhook(request: Request):
    # Платеж подтвержден
    order.status = "paid"
    await db.save(order)
    
    # Публикуем задачу в QStash
    await qstash.publish_json(
        url="https://your-app.vercel.app/api/workers/deliver-goods",
        body={"order_id": order.id},
        retries=3  # Автоматически повторит 3 раза при ошибке
    )
    
    return {"ok": True}  # Vercel замораживает функцию, но задача уже в QStash!
```

**Результат:** Даже если Vercel заморозит функцию, QStash гарантированно доставит задачу на ваш endpoint.

## Простая аналогия

### BackgroundTasks = Почтовый ящик без гарантии

```
Вы кладете письмо в ящик → Почтальон может забрать, а может и нет
Если почтальон не пришел → Письмо потеряно навсегда
```

### QStash = Заказное письмо с уведомлением

```
Вы отправляете заказное письмо → Почта гарантирует доставку
Если не доставлено → Почта повторяет попытку
Вы получаете уведомление о доставке
```

## Когда использовать что?

### BackgroundTasks (Best-Effort)
**Используйте для:**
- ✅ AI-ответы пользователю (если не доставлено - не критично)
- ✅ Логирование
- ✅ Аналитика
- ✅ Кэширование

**Не используйте для:**
- ❌ Доставка товара после оплаты
- ❌ Начисление бонусов
- ❌ Уведомления поставщиков
- ❌ Любые финансовые операции

### QStash (Guaranteed Delivery)
**Используйте для:**
- ✅ Доставка товара после оплаты
- ✅ Начисление реферальных бонусов
- ✅ Уведомления поставщиков о продаже
- ✅ Обновление лидербордов
- ✅ Любые операции, которые **должны** быть выполнены

## Архитектура проекта

### Упрощенная схема

```
┌─────────────────────────────────────────────────┐
│           Vercel Serverless Function            │
│                                                 │
│  1. Получает webhook от платежной системы      │
│  2. Обновляет БД: order.status = "paid"        │
│  3. Публикует задачу в QStash                   │
│  4. Возвращает 200 OK → Vercel замораживает    │
└─────────────────────────────────────────────────┘
                    │
                    ▼
         ┌──────────────────────┐
         │   Upstash QStash     │
         │  (Внешняя очередь)  │
         │                      │
         │  • Хранит задачу     │
         │  • Гарантирует       │
         │    доставку          │
         │  • Повторяет при     │
         │    ошибках           │
         └──────────────────────┘
                    │
                    ▼ (через 1-2 секунды)
┌─────────────────────────────────────────────────┐
│      Vercel Serverless Function (Worker)        │
│                                                 │
│  POST /api/workers/deliver-goods                │
│                                                 │
│  1. Получает задачу от QStash                   │
│  2. Проверяет подпись QStash                   │
│  3. Доставляет товар пользователю               │
│  4. Обновляет лидерборд                         │
└─────────────────────────────────────────────────┘
```

## Почему не Supabase Triggers?

### Supabase Triggers (pg_net)

**Проблемы:**
- ❌ Менее надежны, чем специализированная очередь
- ❌ Нет встроенного retry механизма
- ❌ Сложнее отлаживать
- ❌ Могут потерять задачи при сбоях

### QStash

**Преимущества:**
- ✅ Специализированная очередь для serverless
- ✅ Автоматические повторы
- ✅ Мониторинг и логи
- ✅ Гарантированная доставка

## Настройка Upstash

### Способ 1: Через Vercel Integration (Рекомендуется)

Upstash имеет официальную интеграцию с Vercel:

1. **В Vercel Dashboard:**
   - Перейдите в Settings → Integrations
   - Найдите "Upstash" в списке интеграций
   - Подключите аккаунт Upstash

2. **Автоматическая настройка:**
   - Vercel автоматически создаст Redis и QStash инстансы
   - Переменные окружения будут добавлены автоматически
   - Не нужно вручную копировать токены

**Преимущества:**
- ✅ Автоматическая синхронизация переменных окружения
- ✅ Упрощенное управление через Vercel Dashboard
- ✅ Интеграция с Vercel мониторингом

### Способ 2: Ручная настройка через Upstash Console

Если интеграция недоступна или нужен больший контроль:

1. **Создание Redis:**
   - Перейдите на [console.upstash.com](https://console.upstash.com/)
   - Создайте новый Redis database
   - Скопируйте `UPSTASH_REDIS_URL` и `UPSTASH_REDIS_TOKEN`

2. **Создание QStash:**
   - В том же консоли создайте QStash проект
   - Скопируйте `QSTASH_TOKEN`
   - URL обычно: `https://qstash.upstash.io/v2`

3. **Добавление в Vercel:**
   - Перейдите в Vercel Project → Settings → Environment Variables
   - Добавьте все переменные вручную

## Стоимость

**QStash (Upstash):**
- Бесплатный тариф: 10,000 запросов/день
- Платный: $0.20 за 1M запросов

**Redis (Upstash):**
- Бесплатный тариф: 10,000 команд/день, 256MB storage
- Платный: от $0.20 за 100K команд

**Для проекта:** Если у вас 100-500 покупок в день, бесплатного тарифа более чем достаточно.

## Итог

**QStash = гарантия, что критически важные задачи будут выполнены**

Без QStash:
- Пользователь платит → товар может не доставиться
- Пользователь приглашает друга → бонус может не начислиться
- Проблемы с репутацией и потеря денег

С QStash:
- Все критические операции гарантированно выполняются
- Автоматические повторы при ошибках
- Надежность и доверие пользователей

## Минимальный пример использования

```python
# 1. Установка (уже в requirements.txt)
# pip install upstash-qstash upstash-redis

# 2. Инициализация
from upstash_qstash import QStash
from upstash_redis.asyncio import Redis
import os

qstash = QStash(
    token=os.getenv("QSTASH_TOKEN"),
    url=os.getenv("QSTASH_URL", "https://qstash.upstash.io/v2")
)

# 3. Публикация задачи
await qstash.publish_json(
    url="https://your-app.vercel.app/api/workers/deliver-goods",
    body={"order_id": "123", "user_id": "456"},
    retries=3  # Повторит 3 раза при ошибке
)

# 4. Обработка в worker endpoint
@app.post("/api/workers/deliver-goods")
async def deliver_goods(request: Request):
    # Проверка подписи QStash
    from upstash_qstash import verify_signature
    
    signature = request.headers.get("Upstash-Signature")
    body = await request.body()
    
    if not verify_signature(signature, body, os.getenv("QSTASH_CURRENT_SIGNING_KEY")):
        raise HTTPException(401, "Invalid signature")
    
    # Выполнение задачи
    data = await request.json()
    order_id = data["order_id"]
    
    # Доставка товара...
    await deliver_product_to_user(order_id)
    
    return {"ok": True}
```

## Резюме

**QStash** - это не "еще одна технология", а **необходимый компонент** для надежности критических операций в serverless окружении.

**Альтернатива:** Можно обойтись без QStash, но тогда:
- Риск потери критических задач
- Проблемы с доставкой товаров
- Потеря денег и репутации

**Вывод:** QStash - это инвестиция в надежность, которая окупается отсутствием проблем с доставкой товаров и доверием пользователей.

