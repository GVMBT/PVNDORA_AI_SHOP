# PVNDORA ‚Äî Cron Jobs

## –û–±–∑–æ—Ä

–í—Å–µ —Ñ–æ–Ω–æ–≤—ã–µ –∑–∞–¥–∞—á–∏, –≤—ã–ø–æ–ª–Ω—è–µ–º—ã–µ –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é —á–µ—Ä–µ–∑ Vercel Cron.

**–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:** 2026-01-08

---

## –ê–∫—Ç–∏–≤–Ω—ã–µ Cron Jobs

| –§–∞–π–ª | –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ | –°—Ç–∞—Ç—É—Å | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|------------|--------|----------|
| `unified.py` | */5 * * * * | ‚úÖ –û–°–ù–û–í–ù–û–ô | –û–±—ä–µ–¥–∏–Ω—ë–Ω–Ω—ã–π –∫—Ä–æ–Ω: —ç–∫—Å–ø–∏—Ä–∞—Ü–∏—è –∑–∞–∫–∞–∑–æ–≤, –∞–≤—Ç–æ-–¥–æ—Å—Ç–∞–≤–∫–∞, –∫—É—Ä—Å—ã –≤–∞–ª—é—Ç |
| `auto_alloc.py` | */5 * * * * | ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç | –î–æ—Å—Ç–∞–≤–∫–∞ pending/prepaid –∑–∞–∫–∞–∑–æ–≤ + –∞–≤—Ç–æ-–∑–∞–º–µ–Ω—ã |
| `check_pending_payments.py` | */1 * * * * | ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç | Polling CrystalPay –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –æ–ø–ª–∞—Ç (fallback –≤–µ–±—Ö—É–∫–∞) |
| `deliver_overdue_discount.py` | */5 * * * * | ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç | –î–æ—Å—Ç–∞–≤–∫–∞ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã—Ö –¥–∏—Å–∫–æ–Ω—Ç-–∑–∞–∫–∞–∑–æ–≤ (fallback QStash) |
| `expire_orders.py` | */5 * * * * | üî∂ –î—É–±–ª–∏—Ä—É–µ—Ç | –¢–æ –∂–µ —á—Ç–æ unified.py ‚Äî –∑–∞–¥–∞—á–∞ 1 |
| `daily_cleanup.py` | 0 3 * * * | ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç | –ù–æ—á–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞: —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏–∏, —á–∞—Ç-–∏—Å—Ç–æ—Ä–∏—è, –ø—Ä–æ–º–æ–∫–æ–¥—ã |
| `reengagement.py` | 0 12 * * * | ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç | –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã–º + –∏—Å—Ç–µ–∫–∞—é—â–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏ |
| `refund_expired_prepaid.py` | 0 * * * * | ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç | –ê–≤—Ç–æ-–≤–æ–∑–≤—Ä–∞—Ç prepaid –µ—Å–ª–∏ –¥–µ–¥–ª–∞–π–Ω –∏—Å—Ç—ë–∫ |
| `discount_offers.py` | 0 12 * * * | ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç | –†–∞—Å—Å—ã–ª–∫–∞ –æ—Ñ—Ñ–µ—Ä–æ–≤ –ª–æ—è–ª—å–Ω—ã–º/–Ω–µ–∞–∫—Ç–∏–≤–Ω—ã–º |
| `low_stock_alert.py` | */30 * * * * | ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç | –ê–ª–µ—Ä—Ç—ã –æ –Ω–∏–∑–∫–æ–º —Å—Ç–æ–∫–µ –∞–¥–º–∏–Ω–∞–º |
| `update_exchange_rates.py` | 0 * * * * | ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç | –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫—É—Ä—Å–æ–≤ –≤–∞–ª—é—Ç |

---

## –î–µ—Ç–∞–ª—å–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ

### 1. `unified.py` ‚Äî –û–±—ä–µ–¥–∏–Ω—ë–Ω–Ω—ã–π –∫—Ä–æ–Ω
**–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ:** –ö–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç

**–ó–∞–¥–∞—á–∏:**
1. **–≠–∫—Å–ø–∏—Ä–∞—Ü–∏—è –∑–∞–∫–∞–∑–æ–≤** ‚Äî –û—Ç–º–µ–Ω–∞ pending –∑–∞–∫–∞–∑–æ–≤ —Å –∏—Å—Ç—ë–∫—à–∏–º `expires_at`
2. **–ê–≤—Ç–æ-–¥–æ—Å—Ç–∞–≤–∫–∞** ‚Äî –î–æ—Å—Ç–∞–≤–∫–∞ –æ–ø–ª–∞—á–µ–Ω–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤ (status=paid)
3. **–ö—É—Ä—Å—ã –≤–∞–ª—é—Ç** ‚Äî –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ä–∞–∑ –≤ —á–∞—Å (–µ—Å–ª–∏ minute < 10)

```
–í—Ö–æ–¥–Ω—ã–µ —É—Å–ª–æ–≤–∏—è:
- orders.status = 'pending' AND expires_at < now
- orders.status = 'paid' AND delivered_at IS NULL

–î–µ–π—Å—Ç–≤–∏—è:
- –û—Ç–º–µ–Ω–∞ ‚Üí status = 'cancelled'
- –û—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ stock ‚Üí status = 'available'
- –î–æ—Å—Ç–∞–≤–∫–∞ —á–µ—Ä–µ–∑ DeliveryService
```

---

### 2. `auto_alloc.py` ‚Äî –ê–≤—Ç–æ-–∞–ª–ª–æ–∫–∞—Ü–∏—è —Å—Ç–æ–∫–∞
**–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ:** –ö–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç

**–ó–∞–¥–∞—á–∏:**
1. **–î–æ—Å—Ç–∞–≤–∫–∞ pending/prepaid** ‚Äî –ü–æ–ø—ã—Ç–∫–∞ –¥–æ—Å—Ç–∞–≤–∏—Ç—å –æ–∂–∏–¥–∞—é—â–∏–µ order_items
2. **–ê–≤—Ç–æ-–∑–∞–º–µ–Ω—ã** ‚Äî –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ–¥–æ–±—Ä–µ–Ω–Ω—ã—Ö —Ç–∏–∫–µ—Ç–æ–≤ –Ω–∞ –∑–∞–º–µ–Ω—É

```
–õ–æ–≥–∏–∫–∞ –∑–∞–º–µ–Ω—ã:
1. –ù–∞–π—Ç–∏ —Ç–∏–∫–µ—Ç—ã status='approved', issue_type='replacement'
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞–ª–∏—á–∏–µ stock –¥–ª—è product_id
3. –ï—Å–ª–∏ –µ—Å—Ç—å ‚Üí –¥–æ—Å—Ç–∞–≤–∏—Ç—å + –∑–∞–∫—Ä—ã—Ç—å —Ç–∏–∫–µ—Ç + —É–≤–µ–¥–æ–º–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

–ò—Å–∫–ª—é—á–µ–Ω–∏—è:
- –î–∏—Å–∫–æ–Ω—Ç-–∑–∞–∫–∞–∑—ã (source_channel='discount') –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ
```

---

### 3. `check_pending_payments.py` ‚Äî Polling –æ–ø–ª–∞—Ç
**–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ:** –ö–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** Fallback –¥–ª—è CrystalPay –≤–µ–±—Ö—É–∫–∞

**–õ–æ–≥–∏–∫–∞:**
1. –ù–∞–π—Ç–∏ pending –∑–∞–∫–∞–∑—ã —Å `payment_id` –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 2 —á–∞—Å–∞
2. –ó–∞–ø—Ä–æ—Å–∏—Ç—å —Å—Ç–∞—Ç—É—Å –∏–Ω–≤–æ–π—Å–∞ —á–µ—Ä–µ–∑ CrystalPay API
3. –ï—Å–ª–∏ `state=payed` ‚Üí –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –∫–∞–∫ –æ–ø–ª–∞—á–µ–Ω–Ω—ã–π
4. –ï—Å–ª–∏ `state=cancelled/failed` ‚Üí –æ—Ç–º–µ–Ω–∏—Ç—å –∑–∞–∫–∞–∑

```
–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ –¥–ª—è –¥–∏—Å–∫–æ–Ω—Ç-–∑–∞–∫–∞–∑–æ–≤:
- –†–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç–æ–∫–∞
- –û—Ç–ª–æ–∂–µ–Ω–Ω–∞—è –¥–æ—Å—Ç–∞–≤–∫–∞ —á–µ—Ä–µ–∑ QStash (1-4 —á–∞—Å–∞)
```

---

### 4. `deliver_overdue_discount.py` ‚Äî –î–æ—Å—Ç–∞–≤–∫–∞ –¥–∏—Å–∫–æ–Ω—Ç-–∑–∞–∫–∞–∑–æ–≤
**–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ:** –ö–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** Fallback –¥–ª—è QStash

**–õ–æ–≥–∏–∫–∞:**
1. –ù–∞–π—Ç–∏ –∑–∞–∫–∞–∑—ã: status='paid', source_channel='discount', scheduled_delivery_at < now
2. –î–æ—Å—Ç–∞–≤–∏—Ç—å (–ø–æ–ª—É—á–∏—Ç—å content –∏–∑ stock, –æ–±–Ω–æ–≤–∏—Ç—å order_item)
3. –û—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
4. –û—Ç–ø—Ä–∞–≤–∏—Ç—å warm-up –æ—Ñ—Ñ–µ—Ä –Ω–∞ PVNDORA

```
–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ:
- –ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –ø–æ–∫—É–ø–æ–∫
- –ü—Ä–æ–º–æ–∫–æ–¥ -50% –¥–ª—è –ª–æ—è–ª—å–Ω—ã—Ö (3+ –ø–æ–∫—É–ø–æ–∫)
```

---

### 5. `daily_cleanup.py` ‚Äî –ù–æ—á–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞
**–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ:** 03:00 UTC –µ–∂–µ–¥–Ω–µ–≤–Ω–æ

**–ó–∞–¥–∞—á–∏:**
1. **–û—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏–π** ‚Äî stock_items.status='reserved' —Å—Ç–∞—Ä—à–µ 30 –º–∏–Ω—É—Ç
2. **–û—á–∏—Å—Ç–∫–∞ —á–∞—Ç-–∏—Å—Ç–æ—Ä–∏–∏** ‚Äî chat_history —Å—Ç–∞—Ä—à–µ 30 –¥–Ω–µ–π
3. **–î–µ–∞–∫—Ç–∏–≤–∞—Ü–∏—è –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤** ‚Äî promo_codes —Å –∏—Å—Ç—ë–∫—à–∏–º expires_at
4. **–û—á–∏—Å—Ç–∫–∞ –≤–∏—à–ª–∏—Å—Ç–∞** ‚Äî wishlist —Å—Ç–∞—Ä—à–µ 90 –¥–Ω–µ–π (—É–∂–µ –Ω–∞–ø–æ–º–Ω–∏–ª–∏)

---

### 6. `reengagement.py` ‚Äî –†–µ–∞–∫—Ç–∏–≤–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
**–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ:** 12:00 UTC –µ–∂–µ–¥–Ω–µ–≤–Ω–æ

**–ó–∞–¥–∞—á–∏:**
1. **–ù–µ–∞–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏** ‚Äî last_activity 7-14 –¥–Ω–µ–π –Ω–∞–∑–∞–¥
2. **Wishlist –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è** ‚Äî –¢–æ–≤–∞—Ä—ã –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã–µ 3+ –¥–Ω–µ–π –Ω–∞–∑–∞–¥
3. **–ò—Å—Ç–µ–∫–∞—é—â–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏** ‚Äî expires_at —á–µ—Ä–µ–∑ 2-4 –¥–Ω—è

```
–ó–∞—â–∏—Ç–∞ –æ—Ç —Å–ø–∞–º–∞:
- last_reengagement_at > 3 –¥–Ω–µ–π –Ω–∞–∑–∞–¥
- notified_users set –¥–ª—è –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏
```

---

### 7. `refund_expired_prepaid.py` ‚Äî –ê–≤—Ç–æ-–≤–æ–∑–≤—Ä–∞—Ç
**–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ:** –ö–∞–∂–¥—ã–π —á–∞—Å

**–õ–æ–≥–∏–∫–∞:**
1. –ù–∞–π—Ç–∏ prepaid –∑–∞–∫–∞–∑—ã: fulfillment_deadline < now
2. –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å ‚Üí 'refunded'
3. –í–µ—Ä–Ω—É—Ç—å —Å—Ä–µ–¥—Å—Ç–≤–∞ –Ω–∞ –±–∞–ª–∞–Ω—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
4. –£–≤–µ–¥–æ–º–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

---

### 8. `discount_offers.py` ‚Äî –û—Ñ—Ñ–µ—Ä—ã
**–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ:** 12:00 UTC –µ–∂–µ–¥–Ω–µ–≤–Ω–æ

**–î–µ–ª–µ–≥–∏—Ä—É–µ—Ç:** `OffersService.process_all_offers()`

---

### 9. `low_stock_alert.py` ‚Äî –ê–ª–µ—Ä—Ç—ã –æ —Å—Ç–æ–∫–µ
**–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ:** –ö–∞–∂–¥—ã–µ 30 –º–∏–Ω—É—Ç

**–õ–æ–≥–∏–∫–∞:**
1. –ó–∞–ø—Ä–æ—Å view `low_stock_alert`
2. –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è —Å —ç–º–æ–¥–∑–∏ —Å—Ç–∞—Ç—É—Å–æ–≤
3. –û—Ç–ø—Ä–∞–≤–∫–∞ –≤—Å–µ–º –∞–¥–º–∏–Ω–∞–º (ADMIN_CHAT_IDS)

---

### 10. `update_exchange_rates.py` ‚Äî –ö—É—Ä—Å—ã –≤–∞–ª—é—Ç
**–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ:** –ö–∞–∂–¥—ã–π —á–∞—Å

**–ò—Å—Ç–æ—á–Ω–∏–∫:** exchangerate-api.com

**–í–∞–ª—é—Ç—ã:** USD, RUB, EUR, UAH, TRY, INR, AED, GBP, CNY, JPY, KRW, BRL

---

## –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è

| –ó–∞–¥–∞—á–∞ | –§–∞–π–ª—ã | –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è |
|--------|-------|--------------|
| –≠–∫—Å–ø–∏—Ä–∞—Ü–∏—è –∑–∞–∫–∞–∑–æ–≤ | `unified.py`, `expire_orders.py` | –û—Å—Ç–∞–≤–∏—Ç—å —Ç–æ–ª—å–∫–æ `unified.py` |
| –ê–≤—Ç–æ-–¥–æ—Å—Ç–∞–≤–∫–∞ | `unified.py`, `auto_alloc.py` | –†–∞–∑–Ω—ã–µ –ª–æ–≥–∏–∫–∏ ‚Äî –æ—Å—Ç–∞–≤–∏—Ç—å –æ–±–∞ |
| –ö—É—Ä—Å—ã –≤–∞–ª—é—Ç | `unified.py`, `update_exchange_rates.py` | –û—Å—Ç–∞–≤–∏—Ç—å –æ–±–∞ (—Ä–∞–∑–Ω–æ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ) |

---

## –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Vercel

```json
// vercel.json
{
  "crons": [
    { "path": "/api/cron/unified", "schedule": "*/5 * * * *" },
    { "path": "/api/cron/check_pending_payments", "schedule": "*/1 * * * *" },
    { "path": "/api/cron/daily_cleanup", "schedule": "0 3 * * *" },
    { "path": "/api/cron/reengagement", "schedule": "0 12 * * *" },
    { "path": "/api/cron/refund_expired_prepaid", "schedule": "0 * * * *" },
    { "path": "/api/cron/low_stock_alert", "schedule": "*/30 * * * *" }
  ]
}
```

---

## –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

| –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è | –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ |
|------------|----------------|
| `CRON_SECRET` | –í—Å–µ –∫—Ä–æ–Ω—ã (–∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è) |
| `TELEGRAM_TOKEN` | –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º |
| `DISCOUNT_BOT_TOKEN` | –î–∏—Å–∫–æ–Ω—Ç-–∫–∞–Ω–∞–ª —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è |
| `ADMIN_CHAT_IDS` | low_stock_alert |
| `CRYSTALPAY_LOGIN` | check_pending_payments |
| `CRYSTALPAY_SECRET` | check_pending_payments |

---

## TODO

- [ ] –£–¥–∞–ª–∏—Ç—å `expire_orders.py` (–¥—É–±–ª–∏—Ä—É–µ—Ç `unified.py`)
- [ ] –ö–æ–Ω—Å–æ–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å –ª–æ–≥–∏–∫—É –∞–≤—Ç–æ-–¥–æ—Å—Ç–∞–≤–∫–∏
- [ ] –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç—Ä–∏–∫–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∫—Ä–æ–Ω–æ–≤
