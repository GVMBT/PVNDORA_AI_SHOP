# Диагностика проблемы 1Plat по логам

## Анализ логов

### ✅ Что работает правильно:

1. **Запрос формируется корректно:**
   ```
   1Plat payment creation request for order ...: method=card, amount=38500 kopecks, user_id=339469894
   1Plat payment creation request for order ...: method=card, amount=500000 kopecks, user_id=339469894
   ```
   - Метод передается: `card`
   - Сумма в копейках: `38500` (385 руб) и `500000` (5000 руб) - **проверено с разными суммами**
   - User ID: `339469894`
   - Все параметры правильные

2. **Запрос доходит до 1Plat:**
   ```
   HTTP Request: POST https://1plat.cash/api/merchant/order/create/by-api "HTTP/1.1 500 Internal Server Error"
   ```
   - Запрос успешно отправляется
   - 1Plat получает запрос
   - Но возвращает 500 ошибку

3. **Ответ от 1Plat:**
   ```
   Full response: {'error': 'Не удалось получить реквизиты'}
   ```
   - 1Plat понимает запрос
   - Но не может сгенерировать реквизиты для оплаты

### ❌ Исключенные причины:

- ✅ **Проблема НЕ в сумме:** Ошибка повторяется и на 385 руб, и на 5000 руб
- ✅ **Проблема НЕ в формате запроса:** Запрос формируется правильно, 1Plat его принимает
- ✅ **Проблема НЕ в методе:** Метод `card` передается корректно

## Вывод

**Проблема на стороне 1Plat**, а не в нашем коде. Запрос формируется правильно, но 1Plat не может предоставить реквизиты. **Проблема НЕ связана с суммой платежа.**

## Возможные причины (по приоритету)

### 1. Методы оплаты не включены в ЛК 1Plat (НАИБОЛЕЕ ВЕРОЯТНО)
- **Симптом:** Ошибка "Не удалось получить реквизиты" при любой сумме
- **Решение:** Включить методы оплаты в настройках магазина PVNDORA
- **Где проверить:** PVNDORA → Настройки → Методы оплаты
- **Важно:** Даже если методы видны в списке, они должны быть **активированы/включены**

### 2. Host2Host режим не включен
- **Симптом:** Платежи создаются, но реквизиты не генерируются
- **Решение:** Включить Host2Host в настройках магазина
- **Где проверить:** PVNDORA → Настройки → Host2Host или API настройки

### 3. Баланс 0 ₽ или недостаточный баланс
- **Симптом:** Может блокировать генерацию реквизитов (особенно для p2p эквайринга)
- **Решение:** Пополнить баланс (если требуется)
- **Где проверить:** PVNDORA → Статистика → Общий баланс кассы
- **Примечание:** Для p2p эквайринга может требоваться минимальный баланс для резервирования реквизитов

### 4. Магазин не активирован или на модерации
- **Симптом:** API работает, но реквизиты не генерируются
- **Решение:** Проверить статус магазина в ЛК
- **Где проверить:** PVNDORA → Настройки → Статус магазина

### 5. Проблема на стороне 1Plat (техническая)
- **Симптом:** Ошибка повторяется стабильно при любых параметрах
- **Решение:** Написать в ТП 1Plat
- **Действие:** Кнопка "Поддержка" в правом верхнем углу ЛК

## Что сделать сейчас

### Шаг 1: Проверьте настройки магазина

1. **Откройте:** PVNDORA → Настройки
2. **Проверьте:**
   - ✅ Методы оплаты включены (card, sbp, qr, crypto)
   - ✅ Host2Host режим включен
   - ✅ Магазин активен

### Шаг 2: Попробуйте другой метод

Если `card` не работает, попробуйте:
- `sbp` - СБП
- `qr` - QR-код
- `crypto` - Криптовалюта

Это поможет понять, проблема с конкретным методом или общая.

### Шаг 3: Проверьте главную вкладку "API"

1. **Откройте:** Главное меню → API
2. **Проверьте:**
   - ✅ API доступен
   - ✅ Нет ограничений на использование

### Шаг 4: Если ничего не помогает - напишите в ТП

**Текст для ТП 1Plat:**

```
Здравствуйте!

Shop ID: #1182
Проблема: При создании платежа через API получаю ошибку 500 "Не удалось получить реквизиты"

Запрос:
POST /api/merchant/order/create/by-api
Headers: x-shop: 1182, x-secret: [секретный ключ]
Body: {
  "merchant_order_id": "fb5b44ee-6a9a-4400-b94f-fc1208e97735",
  "user_id": 339469894,
  "amount": 38500,
  "method": "card"
}

Ответ:
500 Internal Server Error
{"error": "Не удалось получить реквизиты"}

Вопрос: Проверьте, пожалуйста:
1. Включены ли методы оплаты для магазина #1182?
2. Доступен ли Host2Host режим?
3. Есть ли ограничения на создание платежей?

Спасибо!
```

## Временное решение

Пока проблема не решена, можно использовать **Freekassa**:
1. Настройте переменные окружения для Freekassa
2. Используйте `payment_gateway: "freekassa"` при создании заказа

## Статус диагностики

- ✅ Код работает правильно
- ✅ Запрос формируется корректно
- ✅ Метод передается (`card`)
- ✅ Проблема НЕ в сумме (проверено: 385 руб и 5000 руб)
- ❌ 1Plat не может сгенерировать реквизиты
- ⚠️ **Требуется проверка настроек в ЛК 1Plat: методы оплаты, Host2Host, баланс**
