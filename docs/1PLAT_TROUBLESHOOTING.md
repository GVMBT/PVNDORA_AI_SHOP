# Диагностика проблем с 1Plat API

## Текущая проблема

**Ошибка:** `1Plat API error 500: Не удалось получить реквизиты`

**Симптомы:**
- Запросы к 1Plat API возвращают 500 ошибку
- Сообщение: "Не удалось получить реквизиты"
- Происходит при создании платежа через `/api/merchant/order/create/by-api`

## Что проверить перед обращением в ТП

### 1. Проверка конфигурации

**Переменные окружения:**
- ✅ `ONEPLAT_SHOP_ID` - должен быть установлен
- ✅ `ONEPLAT_SECRET_KEY` - должен быть установлен
- ✅ `ONEPLAT_API_URL` - по умолчанию `https://1plat.cash`

**Проверка в коде:**
```python
# Логи покажут, что передается в запрос:
# "1Plat payment creation request for order ...: method=card, amount=... kopecks, user_id=..."
```

### 2. Проверка запроса к 1Plat

**Что должно быть в payload:**
```json
{
  "merchant_order_id": "order-uuid",
  "user_id": 339469894,
  "amount": 38500,  // в копейках
  "method": "card"  // ОБЯЗАТЕЛЬНО: card, sbp, qr, crypto
}
```

**Заголовки:**
```
Content-Type: application/json
Accept: application/json
x-shop: {ONEPLAT_SHOP_ID}
x-secret: {ONEPLAT_SECRET_KEY}
```

### 3. Проверка метода оплаты

**Поддерживаемые методы:**
- `card` - Банковская карта
- `sbp` - СБП
- `qr` - QR-код
- `crypto` - Криптовалюта

**Проверка:**
- Метод нормализуется через `_normalize_method()`
- Если метод не поддерживается - будет ошибка до запроса к 1Plat

### 4. Проверка в ЛК 1Plat

**Что проверить:**
1. ✅ Магазин активен и не заблокирован
2. ✅ Методы оплаты включены в настройках магазина
3. ✅ Баланс достаточен для обработки платежей
4. ✅ API ключи правильные (x-shop и x-secret)
5. ✅ Host2Host режим включен (если используется)

### 5. Логи для диагностики

**После деплоя проверьте логи Vercel:**

1. **Запрос к 1Plat:**
   ```
   1Plat payment creation request for order ...: method=card, amount=... kopecks, user_id=...
   1Plat API URL: https://1plat.cash/api/merchant/order/create/by-api
   ```

2. **Ответ от 1Plat:**
   ```
   1Plat API response status: 500 for order ...
   1Plat API error 500 for order ..., method=card. Full response: {...}
   ```

3. **Если успешно:**
   ```
   1Plat payment created for order ..., method=card
   1Plat payment note structure for order ...: ['pan', 'bank', 'fio']
   ```

## Возможные причины ошибки "Не удалось получить реквизиты"

### 1. Проблема на стороне 1Plat
- **Причина:** Временная недоступность сервиса генерации реквизитов
- **Решение:** Повторить запрос через некоторое время
- **Действие:** Написать в ТП 1Plat, если ошибка повторяется

### 2. Метод оплаты не настроен в ЛК
- **Причина:** В настройках магазина не включен выбранный метод (card/sbp/qr/crypto)
- **Решение:** Проверить настройки магазина в ЛК 1Plat
- **Действие:** Включить нужные методы оплаты

### 3. Неправильный метод в запросе
- **Причина:** Передается неподдерживаемый метод
- **Решение:** Проверить логи - какой метод передается
- **Действие:** Убедиться, что метод в списке: card, sbp, qr, crypto

### 4. Проблема с балансом/лимитами
- **Причина:** Недостаточно средств или превышены лимиты
- **Решение:** Проверить баланс и лимиты в ЛК 1Plat
- **Действие:** Пополнить баланс или увеличить лимиты

### 5. Проблема с конфигурацией магазина
- **Причина:** Неправильные настройки Host2Host
- **Решение:** Проверить настройки API в ЛК 1Plat
- **Действие:** Перепроверить x-shop и x-secret

## Что отправить в ТП 1Plat

Если проблема не решается, отправьте в техническую поддержку 1Plat:

1. **Shop ID (x-shop):** `{ONEPLAT_SHOP_ID}`
2. **Время ошибки:** из логов Vercel
3. **Пример запроса:**
   ```json
   {
     "merchant_order_id": "order-uuid",
     "user_id": 339469894,
     "amount": 38500,
     "method": "card"
   }
   ```
4. **Ответ от API:**
   ```
   500 Internal Server Error
   "Не удалось получить реквизиты"
   ```
5. **Логи:** полный traceback из Vercel (если есть)

## Временное решение

Если методы не работают, можно:
1. Попробовать другой метод оплаты (например, `sbp` вместо `card`)
2. Использовать Freekassa как резервный платежный шлюз
3. Проверить, работает ли создание платежей без указания метода (не рекомендуется)

## Проверка работоспособности

**Тест через curl:**
```bash
curl -X POST https://1plat.cash/api/merchant/order/create/by-api \
  -H "Content-Type: application/json" \
  -H "x-shop: {ONEPLAT_SHOP_ID}" \
  -H "x-secret: {ONEPLAT_SECRET_KEY}" \
  -d '{
    "merchant_order_id": "test-order-123",
    "user_id": 339469894,
    "amount": 10000,
    "method": "card"
  }'
```

**Ожидаемый ответ при успехе:**
```json
{
  "success": 1,
  "guid": "...",
  "payment": {
    "note": {
      "pan": "...",
      "bank": "...",
      "fio": "..."
    },
    ...
  },
  "url": "https://pay.1plat.cash/pay/{guid}"
}
```

**Ответ при ошибке:**
```json
{
  "error": "Не удалось получить реквизиты"
}
```

## Рекомендации

1. **Сначала проверьте логи** - добавлено подробное логирование
2. **Проверьте настройки в ЛК 1Plat** - методы должны быть включены
3. **Попробуйте другой метод** - может быть проблема с конкретным методом
4. **Если ничего не помогает** - напишите в ТП 1Plat с логами
