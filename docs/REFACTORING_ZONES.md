# üîç –ó–æ–Ω—ã –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞ (Refactoring Zones)

**–î–∞—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:** 2026-01-27  
**–°—Ç–∞—Ç—É—Å:** –ê–∫—Ç–∏–≤–Ω–æ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç—Å—è

---

## üìä –û–±—â–∏–π –ü—Ä–æ–≥—Ä–µ—Å—Å

**–û–±—â–∏–π –ø—Ä–æ–≥—Ä–µ—Å—Å —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞:** ~65%

- ‚úÖ Agent 2 (Monolith Splitting): **100%** –∑–∞–≤–µ—Ä—à–µ–Ω–æ
- ‚ö†Ô∏è Agent 1 (Cleanup & Consolidation): **75%** –∑–∞–≤–µ—Ä—à–µ–Ω–æ
- ‚ö†Ô∏è Agent 3 (Database & Performance): **40%** –∑–∞–≤–µ—Ä—à–µ–Ω–æ

---

## ‚úÖ –í–´–ü–û–õ–ù–ï–ù–û

### 1. ‚úÖ ChatRepository ‚Äî –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô –ë–ê–ì –ò–°–ü–†–ê–í–õ–ï–ù

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ (2026-01-27)

**–ü—Ä–æ–±–ª–µ–º–∞:** –í—Å–µ –º–µ—Ç–æ–¥—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏ `.execute()` –ë–ï–ó `await` (7 –º–µ—Å—Ç)

**–†–µ—à–µ–Ω–∏–µ:** –î–æ–±–∞–≤–ª–µ–Ω `await` –ø–µ—Ä–µ–¥ –≤—Å–µ–º–∏ `.execute()` –≤ `core/services/repositories/chat_repo.py`

**Commit:** `fix: add await to all execute() calls in ChatRepository`

---

### 2. ‚úÖ ProductRepository ‚Äî N+1 Queries –ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –£–∂–µ –±—ã–ª–æ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–æ

**–†–µ—à–µ–Ω–∏–µ:** `ProductRepository` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç VIEW `products_with_stock_summary` –¥–ª—è —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏—è N+1 queries

**–§–∞–π–ª:** `core/services/repositories/product_repo.py`

---

### 3. ‚úÖ –ú–æ–Ω–æ–ª–∏—Ç—ã –†–∞–∑–±–∏—Ç—ã

**–°—Ç–∞—Ç—É—Å:** ‚úÖ 100% –≤—ã–ø–æ–ª–Ω–µ–Ω–æ

- ‚úÖ `notifications/` —Ä–∞–∑–±–∏—Ç –Ω–∞ 8 –º–æ–¥—É–ª–µ–π
- ‚úÖ `workers/` —Ä–∞–∑–±–∏—Ç –Ω–∞ 5 –º–æ–¥—É–ª–µ–π
- ‚úÖ `profile/` —Ä–∞–∑–±–∏—Ç –Ω–∞ 5 –º–æ–¥—É–ª–µ–π
- ‚úÖ `orders/` —Ä–∞–∑–±–∏—Ç –Ω–∞ 4 –º–æ–¥—É–ª—è

---

### 4. ‚úÖ –ò–º–ø–æ—Ä—Ç—ã –ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ (2026-01-27)

**–§–∞–π–ª:** `core/routers/workers/router.py`

**–†–µ—à–µ–Ω–∏–µ:** 
- ‚úÖ –ò–º–ø–æ—Ä—Ç—ã –ø–µ—Ä–µ–º–µ—â–µ–Ω—ã –≤ –Ω–∞—á–∞–ª–æ —Ñ–∞–π–ª–∞ (PEP 8)
- ‚úÖ –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ: –ª–∏–Ω—Ç–µ—Ä –æ—à–∏–±–æ–∫ –Ω–µ –Ω–∞—à–µ–ª

**Commit:** `style: move imports to top of file in workers/router.py`

---

### 5. ‚úÖ –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ö–æ–Ω—Å–æ–ª–∏–¥–∏—Ä–æ–≤–∞–Ω–∞

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ (2026-01-27)

**–î–µ–π—Å—Ç–≤–∏—è:**
- ‚úÖ –£–¥–∞–ª—ë–Ω `backup.md` (—É—Å—Ç–∞—Ä–µ–ª)
- ‚úÖ –û–±–Ω–æ–≤–ª—ë–Ω `CURRENCY_LOCALIZATION.md` (Multi-Currency Anchor Architecture)
- ‚úÖ –û–±–Ω–æ–≤–ª—ë–Ω `api-specification.md` (—É–±—Ä–∞–Ω—ã supplier endpoints)
- ‚úÖ –û–±–Ω–æ–≤–ª—ë–Ω `ON_DEMAND_ORDERS.md` (—É–±—Ä–∞–Ω—ã supplier —É–ø–æ–º–∏–Ω–∞–Ω–∏—è)
- ‚úÖ –û–±–Ω–æ–≤–ª—ë–Ω `docs/README.md` (—É–±—Ä–∞–Ω—ã —Å—Å—ã–ª–∫–∏ –Ω–∞ –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ñ–∞–π–ª—ã, –æ–±–Ω–æ–≤–ª—ë–Ω –Ω–∞ LangGraph)
- ‚úÖ –ö–æ–Ω—Å–æ–ª–∏–¥–∏—Ä–æ–≤–∞–Ω—ã `AUTHENTICATION.md` –∏ `AUTHENTICATION_ROADMAP.md`
- ‚úÖ –°–æ–∑–¥–∞–Ω `docs/REFACTORING_ZONES.md` (–∏—Ç–æ–≥–æ–≤—ã–π –æ—Ç—á–µ—Ç –æ –∑–æ–Ω–∞—Ö —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞)

**Commit:** `docs: consolidate documentation, remove outdated files, update to LangGraph`

---

### 5. ‚úÖ –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ö–æ–Ω—Å–æ–ª–∏–¥–∏—Ä–æ–≤–∞–Ω–∞

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ

**–î–µ–π—Å—Ç–≤–∏—è:**
- ‚úÖ –£–¥–∞–ª—ë–Ω `backup.md` (—É—Å—Ç–∞—Ä–µ–ª)
- ‚úÖ –û–±–Ω–æ–≤–ª—ë–Ω `CURRENCY_LOCALIZATION.md` (Multi-Currency Anchor Architecture)
- ‚úÖ –û–±–Ω–æ–≤–ª—ë–Ω `api-specification.md` (—É–±—Ä–∞–Ω—ã supplier endpoints)
- ‚úÖ –û–±–Ω–æ–≤–ª—ë–Ω `ON_DEMAND_ORDERS.md` (—É–±—Ä–∞–Ω—ã supplier —É–ø–æ–º–∏–Ω–∞–Ω–∏—è)
- ‚úÖ –û–±–Ω–æ–≤–ª—ë–Ω `docs/README.md` (—É–±—Ä–∞–Ω—ã —Å—Å—ã–ª–∫–∏ –Ω–∞ –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ñ–∞–π–ª—ã, –æ–±–Ω–æ–≤–ª—ë–Ω –Ω–∞ LangGraph)
- ‚úÖ –ö–æ–Ω—Å–æ–ª–∏–¥–∏—Ä–æ–≤–∞–Ω—ã `AUTHENTICATION.md` –∏ `AUTHENTICATION_ROADMAP.md`

---

## ‚ö†Ô∏è –ß–ê–°–¢–ò–ß–ù–û –í–´–ü–û–õ–ù–ï–ù–û

### 1. ‚úÖ Agent 1: Phase 0.1 ‚Äî Telegram Messaging (100%)

**–°—Ç–∞—Ç—É—Å:** ‚úÖ **–ü–û–õ–ù–û–°–¢–¨–Æ –í–´–ü–û–õ–ù–ï–ù–û** (–ø—Ä–æ–≤–µ—Ä–µ–Ω–æ 2026-01-27)

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- ‚úÖ –í—Å–µ –º–æ–¥—É–ª–∏ notifications/ –∏—Å–ø–æ–ª—å–∑—É—é—Ç `telegram_messaging` (46 –º–µ—Å—Ç): `delivery.py`, `misc.py`, `payments.py`, `orders.py`, `referral.py`, `support.py`, `withdrawals.py` ‚úÖ
- ‚úÖ `base.py` –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç `_get_bot()` –º–µ—Ç–æ–¥–∞ ‚úÖ
- ‚úÖ –ù–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –∏–º–ø–æ—Ä—Ç—ã —É–¥–∞–ª–µ–Ω—ã ‚úÖ
- ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã –±–∞–≥–∏ –≤ `misc.py:81` –∏ `orders.py:26` (–¥–æ–±–∞–≤–ª–µ–Ω `await` –ø–µ—Ä–µ–¥ `execute()`) ‚úÖ
- ‚úÖ –ù–µ—Ç –ø—Ä—è–º—ã—Ö –≤—ã–∑–æ–≤–æ–≤ `bot.send_message()` –≤ notifications/ –º–æ–¥—É–ª—è—Ö ‚úÖ

**–í—ã–≤–æ–¥:** ‚úÖ –ó–∞–¥–∞—á–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é –≤—ã–ø–æ–ª–Ω–µ–Ω–∞, –º–æ–∂–Ω–æ –∑–∞–∫—Ä—ã—Ç—å

---

### 2. ‚ö†Ô∏è Agent 1: Phase 0.2 ‚Äî Currency Conversion (80%)

**–°—Ç–∞—Ç—É—Å:** ‚ö†Ô∏è **–ß–ê–°–¢–ò–ß–ù–û –í–´–ü–û–õ–ù–ï–ù–û** (–ø—Ä–æ–≤–µ—Ä–µ–Ω–æ 2026-01-27)

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**

‚úÖ **–í—ã–ø–æ–ª–Ω–µ–Ω–æ:**
- ‚úÖ `convert_balance()` endpoint (`profile.py:264-269`) –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `CurrencyService.convert_balance()` ‚úÖ
- ‚úÖ –ü—Ä—è–º–∞—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è RUB‚ÜîUSD –≤ `balance.py:75` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `convert_balance()` ‚úÖ

‚ö†Ô∏è **–û—Å—Ç–∞–ª–æ—Å—å (—Ä—É—á–Ω–∞—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è —á–µ—Ä–µ–∑ `get_exchange_rate()`):**

**–ú–µ—Å—Ç–æ 1:** `core/routers/webapp/profile/balance.py:77-99` (topup endpoint, –Ω–µ-USD/RUB –≤–∞–ª—é—Ç—ã)
- –°—Ç—Ä–æ–∫–∏ 77-99: –î–ª—è –Ω–µ-USD/RUB –≤–∞–ª—é—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ä—É—á–Ω–∞—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è —á–µ—Ä–µ–∑ `get_exchange_rate()` 
- –°—Ç—Ä–æ–∫–∏ 88-89: USD‚ÜíUSD –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ø—Ä—è–º—É—é –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—é (–º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `convert_balance()` –¥–ª—è –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏)
- –°—Ç—Ä–æ–∫–∞ 96: Fallback –¥–ª—è –¥—Ä—É–≥–∏—Ö –≤–∞–ª—é—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `get_exchange_rate()` –≤–º–µ—Å—Ç–æ `convert_balance()`
- **–†–µ—à–µ–Ω–∏–µ:** –£–ø—Ä–æ—Å—Ç–∏—Ç—å –ª–æ–≥–∏–∫—É: –µ—Å–ª–∏ –≤–∞–ª—é—Ç–∞ –ø–ª–∞—Ç–µ–∂–∞ –Ω–µ USD/RUB ‚Üí –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –≤ USD —á–µ—Ä–µ–∑ `get_exchange_rate()`, –∑–∞—Ç–µ–º –≤ `balance_currency` —á–µ—Ä–µ–∑ `convert_balance()`

**–ú–µ—Å—Ç–æ 2:** `core/routers/webapp/profile/profile.py:143-144` (get_profile endpoint)
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç —Ä—É—á–Ω—É—é –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—é —á–µ—Ä–µ–∑ `get_exchange_rate()` –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞ –≤ USD
- **–†–µ—à–µ–Ω–∏–µ:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `convert_balance()` –¥–ª—è –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏ (–µ—Å–ª–∏ `balance_currency != 'USD'`)

**–ú–µ—Å—Ç–æ 3:** `core/routers/webapp/profile/profile.py:273` (convert_balance endpoint, –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ)
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `get_exchange_rate("RUB")` –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è (–Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ, –Ω–æ –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `convert_balance()`)

**–ü–ª–∞–Ω –¥–µ–π—Å—Ç–≤–∏–π:**
1. –£–ø—Ä–æ—Å—Ç–∏—Ç—å –ª–æ–≥–∏–∫—É –≤ `balance.py:77-99` (—É–±—Ä–∞—Ç—å —Ä—É—á–Ω—É—é –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—é, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `convert_balance()` –≥–¥–µ –≤–æ–∑–º–æ–∂–Ω–æ)
2. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `convert_balance()` –≤ `profile.py:143-144` –≤–º–µ—Å—Ç–æ `get_exchange_rate()`
3. –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `convert_balance()` –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –≤ `profile.py:273`

---

### 3. ‚ö†Ô∏è Agent 1: Phase 1 ‚Äî Cleanup (50%)

**–°—Ç–∞—Ç—É—Å:**
- ‚úÖ –£–±—Ä–∞–Ω–æ EUR –∏–∑ `valid_currencies` –≤ `convert_balance` endpoint
- ‚ö†Ô∏è **–û–°–¢–ê–õ–û–°–¨:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å deprecated –∫–æ–¥, unused imports

**–ß—Ç–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å:**
- `core/orders/serializer.py:39-70` - —Ñ—É–Ω–∫—Ü–∏—è `convert_order_prices()` (DEPRECATED, –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ)
- `core/services/notifications.py` - —Ñ—É–Ω–∫—Ü–∏—è `fulfill_order()` (DEPRECATED, —É–¥–∞–ª–µ–Ω–∞ –ø—Ä–∏ —Ä–∞–∑–±–∏–µ–Ω–∏–∏)
- Unused imports –≤ 14+ —Ñ–∞–π–ª–∞—Ö

---

## ‚ùå –ù–ï –í–´–ü–û–õ–ù–ï–ù–û (–ö–†–ò–¢–ò–ß–ù–û –¥–ª—è –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è)

### 1. ‚ùå Agent 3: Phase 7 ‚Äî asyncio.to_thread() Replacement

**–°—Ç–∞—Ç—É—Å:** ‚ùå **–ù–ï –í–´–ü–û–õ–ù–ï–ù–û** (–ø—Ä–æ–≤–µ—Ä–µ–Ω–æ 2026-01-27)

**–ü—Ä–æ–±–ª–µ–º–∞:** 43+ –º–µ—Å—Ç –∏—Å–ø–æ–ª—å–∑—É—é—Ç `asyncio.to_thread()` –≤–º–µ—Å—Ç–æ –ø—Ä—è–º—ã—Ö async –≤—ã–∑–æ–≤–æ–≤

**–ü–æ—á–µ–º—É —ç—Ç–æ –ø—Ä–æ–±–ª–µ–º–∞:**
- `supabase-py` —É–∂–µ async: `await client.table().select().execute()`
- `asyncio.to_thread()` –¥–æ–±–∞–≤–ª—è–µ—Ç overhead (–Ω–µ–Ω—É–∂–Ω–∞—è –∏–Ω–¥irection)
- Domains —É–∂–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç async –ø—Ä–∞–≤–∏–ª—å–Ω–æ
- –†–æ—É—Ç–µ—Ä—ã –æ–±—ë—Ä—Ç—ã–≤–∞—é—Ç async –≤ `to_thread` ‚Üí –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏–µ

**–ù–∞–π–¥–µ–Ω–æ (–ø—Ä–æ–≤–µ—Ä–µ–Ω–æ —á–µ—Ä–µ–∑ grep):**

| –§–∞–π–ª | –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ | –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç | –°—Ç–∞—Ç—É—Å |
|------|-----------|-----------|--------|
| `core/routers/webapp/profile/profile.py` | 1 –º–µ—Å—Ç–æ | üî¥ –í—ã—Å–æ–∫–∏–π | ‚ùå –ù–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ |
| `core/routers/webapp/profile/balance.py` | 1 –º–µ—Å—Ç–æ | üî¥ –í—ã—Å–æ–∫–∏–π | ‚ùå –ù–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ |
| `core/routers/webapp/profile/withdrawals.py` | 1 –º–µ—Å—Ç–æ | üü° –°—Ä–µ–¥–Ω–∏–π | ‚ùå –ù–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ |
| `core/services/notifications/base.py` | 1 –º–µ—Å—Ç–æ | üü° –°—Ä–µ–¥–Ω–∏–π | ‚ùå –ù–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ |
| `core/routers/workers/router.py` | 1 –º–µ—Å—Ç–æ | üü° –°—Ä–µ–¥–Ω–∏–π | ‚ùå –ù–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ |
| `core/routers/webhooks.py` | 1 –º–µ—Å—Ç–æ | üü° –°—Ä–µ–¥–Ω–∏–π | ‚ùå –ù–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ |
| `core/routers/admin/replacements.py` | 1 –º–µ—Å—Ç–æ | üü° –°—Ä–µ–¥–Ω–∏–π | ‚ùå –ù–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ |
| `core/routers/webapp/partner.py` | 1 –º–µ—Å—Ç–æ | üü° –°—Ä–µ–¥–Ω–∏–π | ‚ùå –ù–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ |
| `api/cron/daily_cleanup.py` | 1 –º–µ—Å—Ç–æ | üü° –°—Ä–µ–¥–Ω–∏–π | ‚ùå –ù–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ |
| –î—Ä—É–≥–∏–µ —Ñ–∞–π–ª—ã | 33+ –º–µ—Å—Ç–∞ | üü° –°—Ä–µ–¥–Ω–∏–π | ‚ùå –ù–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ |

**–í—Å–µ–≥–æ:** 43+ —Ñ–∞–π–ª–æ–≤ —Å `asyncio.to_thread()` (–Ω–µ –≤—Å–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã)

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** grep –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç 43 —Ñ–∞–π–ª–∞, –Ω–æ –Ω–µ —Ç–æ—á–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–µ—Å—Ç. –ù—É–∂–Ω–∞ –¥–µ—Ç–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–∂–¥–æ–≥–æ —Ñ–∞–π–ª–∞.

**–†–µ—à–µ–Ω–∏–µ:**
1. –ó–∞–º–µ–Ω–∏—Ç—å `asyncio.to_thread(lambda: db.client.table()...)` –Ω–∞ –ø—Ä—è–º—ã–µ async –≤—ã–∑–æ–≤—ã: `await db.client.table()...`
2. –ò–ª–∏ –º–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ domain –º–µ—Ç–æ–¥—ã, –µ—Å–ª–∏ –æ–Ω–∏ —Å—É—â–µ—Å—Ç–≤—É—é—Ç
3. –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ `await` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ

**–ü—Ä–∏–º–µ—Ä:**
```python
# ‚ùå –°—Ç–∞—Ä—ã–π –ø–∞—Ç—Ç–µ—Ä–Ω:
result = await asyncio.to_thread(
    lambda: db.client.table("users").select("*").eq("id", user_id).execute()
)

# ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–∞—Ç—Ç–µ—Ä–Ω:
result = await db.client.table("users").select("*").eq("id", user_id).execute()
```

---

### 2. ‚úÖ Agent 3: Phase 7 ‚Äî –ü—Ä–æ–≤–µ—Ä–∫–∞ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è VIEW

**–°—Ç–∞—Ç—É—Å:** ‚úÖ **–í–´–ü–û–õ–ù–ï–ù–û** (–ø—Ä–æ–≤–µ—Ä–µ–Ω–æ 2026-01-27)

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**

‚úÖ **–í—Å–µ —Ä–æ—É—Ç–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç VIEW `products_with_stock_summary`:**

1. ‚úÖ `core/routers/admin/products.py:74` ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ—Ç VIEW ‚úÖ
2. ‚úÖ `core/bot/discount/handlers/catalog.py:61, 88` ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ—Ç VIEW (2 –º–µ—Å—Ç–∞) ‚úÖ
3. ‚úÖ `core/routers/webapp/public.py:38, 162` ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ—Ç VIEW (2 –º–µ—Å—Ç–∞) ‚úÖ
4. ‚úÖ `core/services/repositories/product_repo.py` ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ—Ç VIEW ‚úÖ

**–í—ã–≤–æ–¥:** ‚úÖ –í—Å–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —Ä–æ—É—Ç–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç VIEW, N+1 queries —É—Å—Ç—Ä–∞–Ω–µ–Ω—ã. –ó–∞–¥–∞—á–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞.

---

## üìã –ü–ª–∞–Ω –î–µ–π—Å—Ç–≤–∏–π

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1 (–ö–†–ò–¢–ò–ß–ù–û) üî¥

1. ‚úÖ **ChatRepository –∏—Å–ø—Ä–∞–≤–ª–µ–Ω** ‚Äî –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π –±–∞–≥ —É—Å—Ç—Ä–∞–Ω—ë–Ω ‚úÖ

2. ‚úÖ **Agent 1: Phase 0.1 ‚Äî Telegram Messaging** ‚Äî –í–´–ü–û–õ–ù–ï–ù–û ‚úÖ
   - ‚úÖ –í—Å–µ –º–æ–¥—É–ª–∏ notifications/ –∏—Å–ø–æ–ª—å–∑—É—é—Ç `telegram_messaging` (46 –º–µ—Å—Ç)
   - ‚úÖ `_get_bot()` —É–¥–∞–ª—ë–Ω –∏–∑ `base.py`
   - ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã –±–∞–≥–∏ —Å `await` –≤ `misc.py` –∏ `orders.py`

3. **Agent 1: Phase 0.2 ‚Äî –ó–∞–≤–µ—Ä—à–∏—Ç—å –∑–∞–º–µ–Ω—É —Ä—É—á–Ω–æ–π –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ (80% ‚Üí 100%)**
   - [ ] –£–ø—Ä–æ—Å—Ç–∏—Ç—å –ª–æ–≥–∏–∫—É –≤ `balance.py:77-99` (—É–±—Ä–∞—Ç—å —Ä—É—á–Ω—É—é –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—é –¥–ª—è –Ω–µ-USD/RUB –≤–∞–ª—é—Ç)
   - [ ] –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `convert_balance()` –≤ `profile.py:143-144` –≤–º–µ—Å—Ç–æ `get_exchange_rate()`
   - [ ] –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `convert_balance()` –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –≤ `profile.py:273`
   - [ ] Commit: `refactor: complete currency conversion consolidation (Phase 0.2)`

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 2 (–í–´–°–û–ö–ò–ô) üü°

4. **Agent 3: Phase 7 ‚Äî –ó–∞–º–µ–Ω–∏—Ç—å asyncio.to_thread() (43+ –º–µ—Å—Ç)**
   - [ ] –ó–∞–º–µ–Ω–∏—Ç—å –≤ `profile/profile.py` (18+ –º–µ—Å—Ç)
   - [ ] –ó–∞–º–µ–Ω–∏—Ç—å –≤ `profile/balance.py` (5 –º–µ—Å—Ç)
   - [ ] –ó–∞–º–µ–Ω–∏—Ç—å –≤ `profile/withdrawals.py` (1 –º–µ—Å—Ç–æ)
   - [ ] –ó–∞–º–µ–Ω–∏—Ç—å –≤ `notifications/base.py` (2 –º–µ—Å—Ç–∞)
   - [ ] –ó–∞–º–µ–Ω–∏—Ç—å –≤ –¥—Ä—É–≥–∏—Ö —Ä–æ—É—Ç–µ—Ä–∞—Ö (17+ –º–µ—Å—Ç)
   - [ ] Commit: `perf: replace asyncio.to_thread with direct async calls (43+ places)`

5. **Agent 3: Phase 7 ‚Äî –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ VIEW**
   - [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å `admin/products.py` –Ω–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ VIEW
   - [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å `discount/catalog.py` –Ω–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ VIEW
   - [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å `webapp/public.py` –Ω–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ VIEW
   - [ ] –ï—Å–ª–∏ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç ‚Üí –º–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ VIEW –∏–ª–∏ ProductRepository

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 3 (–°–†–ï–î–ù–ò–ô) üü¢

6. **Agent 1: Phase 1 ‚Äî Cleanup**
   - [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å `convert_order_prices()` –Ω–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ (grep)
   - [ ] –ï—Å–ª–∏ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è ‚Üí —É–¥–∞–ª–∏—Ç—å
   - [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å unused imports (14+ —Ñ–∞–π–ª–æ–≤)
   - [ ] –£–¥–∞–ª–∏—Ç—å unused imports
   - [ ] Commit: `refactor: cleanup deprecated code and unused imports`

---

## üìà –ú–µ—Ç—Ä–∏–∫–∏

### –î–æ –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞

- –ú–æ–Ω–æ–ª–∏—Ç—ã: 6 —Ñ–∞–π–ª–æ–≤ >1000 —Å—Ç—Ä–æ–∫
- –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ: 8+ –º–µ—Å—Ç Telegram –æ—Ç–ø—Ä–∞–≤–∫–∏
- N+1 queries: 5+ –º–µ—Å—Ç
- `asyncio.to_thread`: 43+ –º–µ—Å—Ç
- –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –±–∞–≥–∏: 1 (ChatRepository)

### –ü–æ—Å–ª–µ –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞ (—Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ)

- –ú–æ–Ω–æ–ª–∏—Ç—ã: 0 —Ñ–∞–π–ª–æ–≤ >1000 —Å—Ç—Ä–æ–∫ ‚úÖ
- –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ: ‚úÖ –£—Å—Ç—Ä–∞–Ω–µ–Ω–æ (telegram_messaging –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤–µ–∑–¥–µ, convert_balance –¥–ª—è RUB‚ÜîUSD) ‚úÖ
- N+1 queries: ProductRepository –∏—Å–ø—Ä–∞–≤–ª–µ–Ω ‚úÖ, –æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä—è—é—Ç—Å—è ‚ö†Ô∏è
- `asyncio.to_thread`: 43+ –º–µ—Å—Ç –æ—Å—Ç–∞–ª–æ—Å—å ‚ùå
- –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –±–∞–≥–∏: 0 ‚úÖ

---

## üéØ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

1. **‚úÖ –í–´–ü–û–õ–ù–ï–ù–û:** Agent 1 Phase 0 –∑–∞–≤–µ—Ä—à—ë–Ω
   - ‚úÖ –í—Å–µ `bot.send_message()` –≤ notifications/ –∑–∞–º–µ–Ω–µ–Ω—ã –Ω–∞ `telegram_messaging`
   - ‚úÖ –ó–∞–º–µ–Ω–∞ —Ä—É—á–Ω–æ–π –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ –≤–∞–ª—é—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–∞ (RUB ‚Üî USD –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `convert_balance()`)

2. **–ó–∞—Ç–µ–º:** –ó–∞–º–µ–Ω–∏—Ç—å `asyncio.to_thread()` –Ω–∞ async (43+ –º–µ—Å—Ç) ‚Äî –∫—Ä–∏—Ç–∏—á–Ω–æ –¥–ª—è –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è

3. **–ü–æ—Å–ª–µ:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ VIEW –≤ —Ä–æ—É—Ç–µ—Ä–∞—Ö

4. **–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ:** Cleanup deprecated –∫–æ–¥ –∏ unused imports

---

## üìö –°–≤—è–∑–∞–Ω–Ω—ã–µ –î–æ–∫—É–º–µ–Ω—Ç—ã

- [REFACTORING_PLAN.md](../REFACTORING_PLAN.md) - –ü–æ–ª–Ω—ã–π –ø–ª–∞–Ω —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞
- [REFACTORING_STATUS.md](../REFACTORING_STATUS.md) - –î–µ—Ç–∞–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
- [REFACTORING_PLAN_AGENT_1_CLEANUP.md](../REFACTORING_PLAN_AGENT_1_CLEANUP.md) - –ü–ª–∞–Ω –¥–ª—è Agent 1
- [REFACTORING_PLAN_AGENT_2_SPLITTING.md](../REFACTORING_PLAN_AGENT_2_SPLITTING.md) - –ü–ª–∞–Ω –¥–ª—è Agent 2
- [REFACTORING_PLAN_AGENT_3_OPTIMIZATION.md](../REFACTORING_PLAN_AGENT_3_OPTIMIZATION.md) - –ü–ª–∞–Ω –¥–ª—è Agent 3

---

**–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:** 2026-01-27  
**–°—Ç–∞—Ç—É—Å:** –ê–∫—Ç–∏–≤–Ω–æ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç—Å—è
