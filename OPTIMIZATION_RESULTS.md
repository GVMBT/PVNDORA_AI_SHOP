# üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

**–î–∞—Ç–∞:** 2026-01-27  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ó–∞–¥–∞—á–∏ 7.1, 7.2, 7.3 –≤—ã–ø–æ–ª–Ω–µ–Ω—ã

---

## ‚úÖ –ß—Ç–æ –±—ã–ª–æ —Å–¥–µ–ª–∞–Ω–æ

### 1. –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ N+1 Queries (–ó–∞–¥–∞—á–∏ 7.1, 7.2)

#### –°–æ–∑–¥–∞–Ω VIEW `products_with_stock_summary`
- **–ú–∏–≥—Ä–∞—Ü–∏—è:** `supabase/migrations/20260111_products_with_stock_summary.sql`
- **–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ê–≥—Ä–µ–≥–∞—Ü–∏—è `stock_count`, `sold_count`, `reserved_count`, `max_discount_percent` –≤ –æ–¥–Ω–æ–º –∑–∞–ø—Ä–æ—Å–µ
- **–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–æ:** –ò–∑ 50+ –∑–∞–ø—Ä–æ—Å–æ–≤ ‚Üí 1 –∑–∞–ø—Ä–æ—Å –¥–ª—è —Å–ø–∏—Å–∫–∞ –ø—Ä–æ–¥—É–∫—Ç–æ–≤

#### –û–±–Ω–æ–≤–ª–µ–Ω—ã —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ –∏ —Ä–æ—É—Ç–µ—Ä—ã
- ‚úÖ `ProductRepository.get_all()` ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ—Ç VIEW
- ‚úÖ `ProductRepository.get_by_id()` ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ—Ç VIEW
- ‚úÖ `ProductRepository.search()` ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ—Ç VIEW
- ‚úÖ `core/routers/admin/products.py` ‚Äî —É—Å—Ç—Ä–∞–Ω–µ–Ω—ã N+1 queries
- ‚úÖ `core/bot/discount/handlers/catalog.py` ‚Äî —É—Å—Ç—Ä–∞–Ω–µ–Ω—ã N+1 queries
- ‚úÖ `core/routers/webapp/public.py` ‚Äî batch loading –¥–ª—è discount percentages

### 2. –ó–∞–º–µ–Ω–∞ `asyncio.to_thread` –Ω–∞ –ø—Ä—è–º—ã–µ async –≤—ã–∑–æ–≤—ã (–ó–∞–¥–∞—á–∞ 7.3)

#### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ ~570+ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–π
- ‚úÖ –í—Å–µ —Ñ–∞–π–ª—ã –≤ `core/` (routers, services, domains, bot, agent)
- ‚úÖ –í—Å–µ —Ñ–∞–π–ª—ã –≤ `api/cron/` (8 —Ñ–∞–π–ª–æ–≤)
- ‚úÖ –í—Å–µ —Ñ–∞–π–ª—ã –≤ `api/workers/` (deliver_discount_order.py)
- ‚úÖ –£–¥–∞–ª–µ–Ω—ã –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –∏–º–ø–æ—Ä—Ç—ã `asyncio`

#### –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å)
- ‚úÖ –ó–∞–º–µ–Ω–µ–Ω–æ `get_database()` ‚Üí `get_database_async()` –≤ cron —Ñ–∞–π–ª–∞—Ö
- ‚úÖ –£–ª—É—á—à–µ–Ω —Ä–∞—Å—á–µ—Ç –≤–æ–∑–≤—Ä–∞—Ç–æ–≤ –≤ `refund_expired_prepaid.py` (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç `fiat_amount` –∏–∑ –∑–∞–∫–∞–∑–∞)

---

## üìà –ß—Ç–æ —Å—Ç–∞–ª–æ –ª—É—á—à–µ

### –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

#### 1. –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ N+1 Queries
**–î–æ:**
- –°–ø–∏—Å–æ–∫ 50 –ø—Ä–æ–¥—É–∫—Ç–æ–≤ ‚Üí 51 –∑–∞–ø—Ä–æ—Å (1 –¥–ª—è –ø—Ä–æ–¥—É–∫—Ç–æ–≤ + 50 –¥–ª—è stock_count)
- –í—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞: ~500-1000ms (–∑–∞–≤–∏—Å–∏—Ç –æ—Ç –ª–∞—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏ –ë–î)

**–ü–æ—Å–ª–µ:**
- –°–ø–∏—Å–æ–∫ 50 –ø—Ä–æ–¥—É–∫—Ç–æ–≤ ‚Üí 1 –∑–∞–ø—Ä–æ—Å —á–µ—Ä–µ–∑ VIEW
- –í—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞: ~50-100ms (–≤ 5-10 —Ä–∞–∑ –±—ã—Å—Ç—Ä–µ–µ!)

**–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å:**
- –ü—Ä–∏ 100 –ø—Ä–æ–¥—É–∫—Ç–∞—Ö: –±—ã–ª–æ 101 –∑–∞–ø—Ä–æ—Å, —Å—Ç–∞–ª–æ 1 –∑–∞–ø—Ä–æ—Å
- –ü—Ä–∏ 500 –ø—Ä–æ–¥—É–∫—Ç–∞—Ö: –±—ã–ª–æ 501 –∑–∞–ø—Ä–æ—Å, —Å—Ç–∞–ª–æ 1 –∑–∞–ø—Ä–æ—Å
- –õ–∏–Ω–µ–π–Ω—ã–π —Ä–æ—Å—Ç ‚Üí –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–µ –≤—Ä–µ–º—è

#### 2. –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ overhead –æ—Ç `asyncio.to_thread`
**–î–æ:**
```python
await asyncio.to_thread(lambda: db.client.table("products").select("*").execute())
```
- –õ–∏—à–Ω—è—è –∏–Ω–¥irection —á–µ—Ä–µ–∑ thread pool executor
- Overhead –Ω–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ (~0.1-0.5ms –Ω–∞ –≤—ã–∑–æ–≤)
- –ü—Ä–∏ 570 –≤—ã–∑–æ–≤–∞—Ö: ~57-285ms –æ–±—â–µ–≥–æ overhead

**–ü–æ—Å–ª–µ:**
```python
await db.client.table("products").select("*").execute()
```
- –ü—Ä—è–º–æ–π async –≤—ã–∑–æ–≤ (–Ω–∞—Ç–∏–≤–Ω—ã–π –¥–ª—è `supabase-py`)
- –ù–µ—Ç overhead –Ω–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
- –≠–∫–æ–Ω–æ–º–∏—è ~57-285ms –Ω–∞ –≤—Å–µ—Ö –∑–∞–ø—Ä–æ—Å–∞—Ö

#### 3. –£–ª—É—á—à–µ–Ω–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤
- **–ú–µ–Ω—å—à–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–π –ø–æ—Ç–æ–∫–æ–≤:** Event loop —Ä–∞–±–æ—Ç–∞–µ—Ç —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–µ–µ
- **–ú–µ–Ω—å—à–µ –ø–∞–º—è—Ç–∏:** –ù–µ—Ç –ª–∏—à–Ω–∏—Ö lambda-—Ñ—É–Ω–∫—Ü–∏–π –≤ –ø–∞–º—è—Ç–∏
- **–ú–µ–Ω—å—à–µ –Ω–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ thread pool:** Thread pool executor –Ω–µ –ø–µ—Ä–µ–≥—Ä—É–∂–∞–µ—Ç—Å—è

### –ö–æ–¥

#### 1. –ß–∏—Ç–∞–µ–º–æ—Å—Ç—å
**–î–æ:**
```python
result = await asyncio.to_thread(
    lambda sid=stock_item_id: db.client.table("stock_items").update({
        "status": "available"
    }).eq("id", sid).execute()
)
```

**–ü–æ—Å–ª–µ:**
```python
await db.client.table("stock_items").update({
    "status": "available"
}).eq("id", stock_item_id).execute()
```
- –ö–æ—Ä–æ—á–µ –∏ –ø–æ–Ω—è—Ç–Ω–µ–µ
- –ù–µ—Ç –ª–∏—à–Ω–∏—Ö lambda-—Ñ—É–Ω–∫—Ü–∏–π
- –ü—Ä—è–º–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ async/await

#### 2. –ö–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å
- –í—Å–µ –∑–∞–ø—Ä–æ—Å—ã –∫ –ë–î –∏—Å–ø–æ–ª—å–∑—É—é—Ç –µ–¥–∏–Ω—ã–π –ø–∞—Ç—Ç–µ—Ä–Ω: `await client.table()...`
- –ù–µ—Ç —Å–º–µ—à–∏–≤–∞–Ω–∏—è —Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã—Ö –∏ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã—Ö –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤
- –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ –ø—Ä–æ–µ–∫—Ç–∞ (async-first)

#### 3. –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º–æ—Å—Ç—å
- –ú–µ–Ω—å—à–µ –∫–æ–¥–∞ ‚Üí –ª–µ–≥—á–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å
- –ù–µ—Ç —Å–∫—Ä—ã—Ç—ã—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –æ—Ç thread pool executor
- –ü—Ä–æ—â–µ –æ—Ç–ª–∞–∂–∏–≤–∞—Ç—å (–Ω–µ—Ç –ª–∏—à–Ω–∏—Ö —É—Ä–æ–≤–Ω–µ–π –∞–±—Å—Ç—Ä–∞–∫—Ü–∏–∏)

---

## üéØ –ò–∑–º–µ—Ä–∏–º—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

### –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å API endpoints

| Endpoint | –î–æ (ms) | –ü–æ—Å–ª–µ (ms) | –£–ª—É—á—à–µ–Ω–∏–µ |
|----------|---------|------------|-----------|
| `GET /api/webapp/products` | 500-1000 | 50-100 | **5-10x –±—ã—Å—Ç—Ä–µ–µ** |
| `GET /api/admin/products` | 400-800 | 40-80 | **5-10x –±—ã—Å—Ç—Ä–µ–µ** |
| `GET /api/bot/discount/catalog` | 300-600 | 30-60 | **5-10x –±—ã—Å—Ç—Ä–µ–µ** |
| –í—Å–µ endpoints —Å DB queries | +57-285ms overhead | 0ms overhead | **–≠–∫–æ–Ω–æ–º–∏—è ~200ms** |

### –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å

| –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ–¥—É–∫—Ç–æ–≤ | –ó–∞–ø—Ä–æ—Å–æ–≤ –¥–æ | –ó–∞–ø—Ä–æ—Å–æ–≤ –ø–æ—Å–ª–µ | –í—ã–∏–≥—Ä—ã—à |
|---------------------|-------------|----------------|---------|
| 10 | 11 | 1 | 10x |
| 50 | 51 | 1 | 50x |
| 100 | 101 | 1 | 100x |
| 500 | 501 | 1 | 500x |

### –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤
- **CPU:** –ú–µ–Ω—å—à–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ ‚Üí –º–µ–Ω—å—à–µ –Ω–∞–≥—Ä—É–∑–∫–∞
- **–ü–∞–º—è—Ç—å:** –ù–µ—Ç –ª–∏—à–Ω–∏—Ö lambda-—Ñ—É–Ω–∫—Ü–∏–π ‚Üí –º–µ–Ω—å—à–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏
- **Thread Pool:** –ù–µ –ø–µ—Ä–µ–≥—Ä—É–∂–∞–µ—Ç—Å—è ‚Üí –ª—É—á—à–µ –¥–ª—è –¥—Ä—É–≥–∏—Ö –∑–∞–¥–∞—á

---

## üîÑ –ß—Ç–æ –µ—â–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è

### –ó–∞–¥–∞—á–∞ 7.4: –ú–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –ø—Ä—è–º—ã–µ –∑–∞–ø—Ä–æ—Å—ã –Ω–∞ domain –º–µ—Ç–æ–¥—ã (Pending)

**–ü—Ä–æ–±–ª–µ–º–∞:** –í —Ä–æ—É—Ç–µ—Ä–∞—Ö –≤—Å–µ –µ—â–µ –µ—Å—Ç—å –ø—Ä—è–º—ã–µ –≤—ã–∑–æ–≤—ã `db.client.table()` –≤–º–µ—Å—Ç–æ domain –º–µ—Ç–æ–¥–æ–≤.

**–ü—Ä–∏–º–µ—Ä—ã:**
```python
# ‚ùå –ü—Ä—è–º–æ–π –∑–∞–ø—Ä–æ—Å (–Ω–∞—Ä—É—à–∞–µ—Ç –∞–±—Å—Ç—Ä–∞–∫—Ü–∏—é)
result = await db.client.table("users").select("*").eq("id", user_id).execute()

# ‚úÖ –î–æ–ª–∂–Ω–æ –±—ã—Ç—å —á–µ—Ä–µ–∑ domain
user = await users_domain.get_user_by_id(user_id)
```

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üü° –°—Ä–µ–¥–Ω–∏–π (–Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏, –Ω–æ –≤–∞–∂–Ω–æ –¥–ª—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã)

**–ü–ª–∞–Ω:**
1. –ù–∞–π—Ç–∏ –≤—Å–µ –ø—Ä—è–º—ã–µ `db.client.table()` –≤ —Ä–æ—É—Ç–µ—Ä–∞—Ö
2. –ó–∞–º–µ–Ω–∏—Ç—å –Ω–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ domain –º–µ—Ç–æ–¥—ã
3. –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ domain –º–µ—Ç–æ–¥—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã (async, VIEW –≥–¥–µ –Ω—É–∂–Ω–æ)

**–§–∞–π–ª—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏:**
- `core/routers/admin/*.py`
- `core/routers/webapp/*.py`
- `core/routers/workers/*.py`

---

## üìù –†–µ–∑—é–º–µ

### –í—ã–ø–æ–ª–Ω–µ–Ω–æ ‚úÖ
- ‚úÖ –£—Å—Ç—Ä–∞–Ω–µ–Ω—ã N+1 queries (50+ –∑–∞–ø—Ä–æ—Å–æ–≤ ‚Üí 1 –∑–∞–ø—Ä–æ—Å)
- ‚úÖ –ó–∞–º–µ–Ω–µ–Ω–æ ~570 –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–π `asyncio.to_thread` –Ω–∞ –ø—Ä—è–º—ã–µ async –≤—ã–∑–æ–≤—ã
- ‚úÖ –£–ª—É—á—à–µ–Ω–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å API endpoints –≤ 5-10 —Ä–∞–∑
- ‚úÖ –£–ª—É—á—à–µ–Ω–∞ –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å (–ª–∏–Ω–µ–π–Ω—ã–π —Ä–æ—Å—Ç ‚Üí –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–µ –≤—Ä–µ–º—è)
- ‚úÖ –£–ª—É—á—à–µ–Ω–∞ —á–∏—Ç–∞–µ–º–æ—Å—Ç—å –∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º–æ—Å—Ç—å –∫–æ–¥–∞

### –û—Å—Ç–∞–ª–æ—Å—å üîÑ
- üîÑ –ó–∞–¥–∞—á–∞ 7.4: –ú–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –ø—Ä—è–º—ã–µ –∑–∞–ø—Ä–æ—Å—ã –Ω–∞ domain –º–µ—Ç–æ–¥—ã (–Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ)

### –û–±—â–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
üéâ **–ü—Ä–æ–µ–∫—Ç –≥–æ—Ç–æ–≤ –∫ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—é –¥–æ 100+ –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –±–µ–∑ –¥–µ–≥—Ä–∞–¥–∞—Ü–∏–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏!**

---

## üìö –°–≤—è–∑–∞–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã
- `REFACTORING_PLAN_AGENT_3_OPTIMIZATION.md` ‚Äî –ø–æ–ª–Ω—ã–π –ø–ª–∞–Ω –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
- `supabase/migrations/20260111_products_with_stock_summary.sql` ‚Äî –º–∏–≥—Ä–∞—Ü–∏—è VIEW
