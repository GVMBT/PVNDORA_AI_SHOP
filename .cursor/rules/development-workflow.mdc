---
alwaysApply: true
---

# Development Workflow & Quality Rules

## CRITICAL: Always Study Existing Code Before Making Changes

**Rule:** Before writing ANY new code or modifying existing code, you MUST:

1. **Read and understand the current implementation** - Use `read_file`, `grep`, `codebase_search`
2. **Check for duplicates** - Search for similar names using `grep` before adding functions/classes/endpoints
3. **Run linters** - `python -m pyflakes <files>` before committing
4. **Check Python 3.12 compatibility** - No `datetime.utcnow()`, use `datetime.now(timezone.utc)`

## Pre-Commit Checklist

- [ ] Read existing code in the file you're modifying
- [ ] Search for duplicate function/class names
- [ ] Check imports are correct and not circular
- [ ] Run `pyflakes` on modified files
- [ ] Verify no syntax errors (Python 3.12 compatible)
- [ ] Verify endpoint paths don't conflict with existing routes

## Common Pitfalls

- ❌ Duplicate function names in same module
- ❌ `datetime.utcnow()` (deprecated in Python 3.12)
- ❌ Unused variables
- ❌ Missing imports (`timezone` not imported)
- ❌ Importing non-existent modules

## Database Migrations (CRITICAL)

**Rule:** When creating or modifying database views/functions/tables:

1. **Create migration file** in `supabase/migrations/` with descriptive name
2. **Apply migration immediately** using `mcp_supabase_apply_migration`
3. **Verify view/function matches API expectations** - Check field names match exactly (case-sensitive)
4. **Test API endpoint** before marking task complete

**Common Issues:**

- View field names don't match API expectations → Check API code, update view with aliases
- Missing fields → Join with other views or calculate in view
- Data type mismatches → Use explicit casts and COALESCE

**MCP Tools Usage:**

- `mcp_supabase_apply_migration` - For creating/modifying views/functions/tables/indexes
- `mcp_supabase_execute_sql` - For testing queries, one-time updates, debugging
- `mcp_supabase_list_tables` - For verifying table structure

**Pre-Migration Checklist:**

- [ ] Check existing views/functions that might be affected
- [ ] Review API endpoints that use database
- [ ] Check for similar patterns in codebase

**Post-Migration Checklist:**

- [ ] Migration file created and applied
- [ ] View/function field names match API expectations
- [ ] All required fields are present
- [ ] Data types are correct
- [ ] NULL handling is consistent
- [ ] API endpoint tested and working
- [ ] Frontend can load data

**See `docs/database-schema.md` for detailed examples and patterns.**
