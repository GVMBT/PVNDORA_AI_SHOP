<!-- 6f20b825-4c9f-4247-a93c-5bd1af4223bb 6a5b2a86-e057-406c-8d99-eb4305b008b6 -->
# PVNDORA AI Marketplace Implementation Plan

## Architecture Overview

Single FastAPI entry point (`api/index.py`) to respect Vercel Hobby 12-function limit. All bot logic, API routes, and webhooks consolidated into one application.

```
pvndora/
├── api/
│   └── index.py              # FastAPI app with all routes
├── src/
│   ├── bot/
│   │   ├── __init__.py
│   │   ├── handlers.py       # Message/command handlers
│   │   ├── middlewares.py    # Auth, language, analytics
│   │   └── keyboards.py      # Inline keyboards
│   ├── ai/
│   │   ├── __init__.py
│   │   ├── consultant.py     # Gemini integration
│   │   ├── tools.py          # Function calling definitions
│   │   └── prompts.py        # System prompts
│   ├── services/
│   │   ├── __init__.py
│   │   ├── database.py       # Supabase client
│   │   ├── payments.py       # AAIO + Stripe
│   │   └── notifications.py  # Telegram notifications
│   ├── i18n/
│   │   ├── __init__.py
│   │   └── translations.py   # Translation loader
│   └── utils/
│       ├── __init__.py
│       └── validators.py     # initData validation
├── locales/                   # JSON translation files
│   ├── ru.json
│   ├── en.json
│   └── ...
├── webapp/                    # React Mini App (existing structure)
│   └── src/
├── requirements.txt
└── vercel.json
```

## Phase 1: Core Infrastructure

### 1.1 Project Setup

- Update `requirements.txt` with finalized dependencies
- Configure `vercel.json` for Python runtime and routing
- Create directory structure for bot modules

### 1.2 Database Schema Completion

Current tables exist but need additional columns:

- `stock_items`: add `expires_at`, `supplier_id` for subscription tracking
- `orders`: add `original_price`, `discount_percent`, `refund_requested` for dynamic pricing
- Create missing tables: `wishlist`, `promo_codes`, `faq`, `reviews`

### 1.3 Supabase Client Service

Create `src/services/database.py`:

- Async Supabase client initialization
- User CRUD operations (create, update language, check ban status)
- Product queries with availability check
- Stock item reservation with `FOR UPDATE` lock
- Order creation with atomic stock deduction

## Phase 2: Telegram Bot Foundation

### 2.1 Bot Initialization

Create aiogram 3.x bot with webhook mode in `api/index.py`:

- Dispatcher with router structure
- Webhook endpoint `/webhook/telegram`
- Bot instance with default properties

### 2.2 Middleware Layer

Create `src/bot/middlewares.py`:

- `AuthMiddleware`: Check user ban status, create user if new
- `LanguageMiddleware`: Extract and save `language_code`
- `ActivityMiddleware`: Update `last_activity_at` timestamp
- `AnalyticsMiddleware`: Log events to `analytics_events`

### 2.3 Command Handlers

Create `src/bot/handlers.py`:

- `/start` with referral parsing (`ref_{telegram_id}`)
- `/my_orders` - purchase history
- `/wishlist` - saved items
- `/help` - FAQ redirect
- Text message handler routing to AI consultant

### 2.4 i18n System

Create `src/i18n/translations.py`:

- JSON file loader for 9 languages (ru, en, de, fr, es, tr, ar, hi, uk)
- `get_text(key, lang)` function
- Fallback to English if translation missing

Create `locales/*.json` with keys:

- welcome, help, order_success, payment_pending, error_generic, etc.

## Phase 3: AI Consultant Integration

### 3.1 Gemini Client

Create `src/ai/consultant.py`:

- Initialize `google-genai` client
- System prompt with marketplace context and product knowledge
- Conversation history management (from `chat_history` table)
- Response generation with streaming support

### 3.2 Function Calling Tools

Create `src/ai/tools.py`:

- `check_product_availability`: Query stock for product
- `get_product_details`: Fetch product info with price
- `create_purchase_intent`: Generate Mini App payment link
- `add_to_waitlist`: Register interest for out-of-stock items
- `search_products`: Find products by criteria

### 3.3 Voice Message Support

In handlers, add voice message processing:

- Download voice file via aiogram
- Send audio bytes to Gemini with `inline_data`
- Process response same as text

### 3.4 System Prompts

Create `src/ai/prompts.py`:

- Consultant personality (helpful, knowledgeable about AI services)
- Product catalog context (injected dynamically)
- Response language instruction based on user's `language_code`
- Intent detection guidelines (purchase, support, inquiry)

## Phase 4: Payment Integration

### 4.1 Payment Router

In `api/index.py`, add payment endpoints:

- `POST /api/orders` - Create order, return payment URL
- `POST /webhook/aaio` - AAIO callback handler
- `POST /webhook/stripe` - Stripe callback handler

### 4.2 AAIO Integration (Russia)

Create AAIO handling in `src/services/payments.py`:

- Generate payment URL with order metadata
- Verify callback signature
- Mark order as paid, trigger fulfillment

### 4.3 Stripe Integration (International)

Create Stripe handling in `src/services/payments.py`:

- Create Checkout Session
- Handle `checkout.session.completed` webhook
- Currency conversion (USD/EUR)

### 4.4 Fulfillment Service

Create fulfillment logic in `src/services/notifications.py`:

- Fetch `stock_item.content` for sold item
- Send credentials to user via Telegram
- Mark `stock_item.is_sold = true`
- Notify supplier via Telegram
- Calculate and credit referral bonus

## Phase 5: Mini App (React)

### 5.1 Payment Page

Update `webapp/src/` with payment flow:

- Parse `startapp` parameter for product/order info
- Fetch product details from `/api/products/{id}`
- Display price with discount if applicable
- Payment method selector (SBP for RU, Card for others)
- Redirect to payment provider

### 5.2 Telegram WebApp Integration

- Initialize `@telegram-apps/sdk`
- Extract and send `initData` for authentication
- Use MainButton for payment confirmation
- Handle payment success/failure callbacks

### 5.3 initData Validation

Create `src/utils/validators.py`:

- HMAC validation of Telegram initData
- Extract user info from validated data
- Middleware for protected API routes

## Phase 6: Admin and Polish

### 6.1 Admin API Endpoints

Add to `api/index.py`:

- `GET /api/admin/orders` - Order list with filters
- `GET /api/admin/users` - User management
- `POST /api/admin/stock` - Add stock items
- `POST /api/admin/broadcast` - Send mass notification

### 6.2 RLS Policies

Apply Row Level Security in Supabase:

- Users can only read own orders
- Products readable by all authenticated
- Admin bypass for management operations

### 6.3 Error Handling

- Graceful degradation when Gemini unavailable
- Payment failure recovery with balance credit
- Rate limiting for AI requests

## Key Files to Create/Modify

1. `api/index.py` - Main FastAPI application (~300 lines)
2. `src/bot/handlers.py` - Telegram handlers (~200 lines)
3. `src/ai/consultant.py` - Gemini integration (~150 lines)
4. `src/services/database.py` - Supabase operations (~200 lines)
5. `src/services/payments.py` - AAIO/Stripe (~150 lines)
6. `src/i18n/translations.py` - i18n system (~50 lines)
7. `locales/ru.json`, `locales/en.json` - Translation files
8. `webapp/src/pages/Payment.jsx` - Payment UI (~150 lines)

## Environment Variables Required

```
TELEGRAM_TOKEN=
TELEGRAM_WEBHOOK_URL=https://pvndora-ai-shop.vercel.app/webhook/telegram
SUPABASE_URL=https://cxthsmadbvgrzjgnuzke.supabase.co
SUPABASE_SERVICE_ROLE_KEY=
GEMINI_API_KEY=
AAIO_MERCHANT_ID=
AAIO_SECRET_KEY=
STRIPE_SECRET_KEY=
STRIPE_WEBHOOK_SECRET=
```

### To-dos

- [ ] Update requirements.txt, vercel.json, create directory structure
- [ ] Apply migrations for missing columns and tables in Supabase
- [ ] Create src/services/database.py with Supabase client and queries
- [ ] Create i18n module and translation files for 9 languages
- [ ] Create aiogram bot with webhook, middlewares, and command handlers
- [ ] Integrate Gemini 2.5 Flash with function calling and voice support
- [ ] Implement AAIO payment integration for Russian users
- [ ] Implement Stripe payment integration for international users
- [ ] Create order fulfillment with credential delivery and notifications
- [ ] Build React payment page with Telegram WebApp SDK
- [ ] Add admin endpoints for order/user/stock management