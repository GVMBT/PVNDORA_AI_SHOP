# Анализ проблемы рейтинга для @gvmbt158

## Текущая ситуация:

- **Всего заказов:** 22
- **Доставлено:** 16 заказов
- **total_saved в БД:** 0.13 USD (~10₽ при курсе ~80)
- **Отображается в рейтинге:** 10₽

## Детальный анализ доставленных заказов:

Из 16 доставленных заказов:
- **Только 2 заказа имеют экономию:**
  - `309140e9-e5c5-486e-9c6d-23876e0d842a`: original_price=10.0, amount=9.99 → экономия 0.01 USD
  - `155d3777-41db-4082-8eeb-c715cc75ddc6`: original_price=10.0, amount=9.99 → экономия 0.01 USD
  - **Итого: 0.02 USD (не 0.13 USD!)**

- **14 заказов без экономии:** original_price = amount (нет скидки)

## Проблема:

1. **`total_saved = 0.13 USD` в БД, но должно быть 0.02 USD** - расхождение в 6.5 раз!
2. **Worker обновляет `total_saved` только для заказов с экономией > 0**
3. **Worker ставит `saved_calculated = True` только если `saved_amount > 0`**
4. **Только 2 заказа из 16 имеют `saved_calculated = True`**

## Возможные причины расхождения:

1. **Старые заказы были обработаны до миграции на асинхронный клиент**
2. **Worker срабатывал несколько раз для одних и тех же заказов (race condition)**
3. **`total_saved` обновлялся вручную или через другой код**

## Рекомендации:

1. **Пересчитать `total_saved` для всех пользователей** из доставленных заказов
2. **Проверить логику worker'а** - возможно race condition при параллельной обработке
3. **Добавить миграцию для пересчета `total_saved`** для всех существующих пользователей
4. **Улучшить логику расчета экономии** - возможно нужно использовать `fiat_amount` вместо `amount` для правильного отображения в валюте пользователя
