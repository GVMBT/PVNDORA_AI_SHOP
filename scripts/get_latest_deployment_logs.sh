#!/bin/bash

# ะกะบัะธะฟั ะดะปั ะฟะพะปััะตะฝะธั runtime ะปะพะณะพะฒ ะฟะพัะปะตะดะฝะธั ะดะตะฟะปะพะนะผะตะฝัะพะฒ ะฒัะตั ะฟัะพะตะบัะพะฒ
# ะัะฟะพะปัะทะพะฒะฐะฝะธะต: ./scripts/get_latest_deployment_logs.sh [--follow]

FOLLOW_FLAG="${1:-}"

echo "๐ ะะพะปััะฐั ัะฟะธัะพะบ ะฟัะพะตะบัะพะฒ..."
PROJECTS=$(vercel project ls --json)

if [ -z "$PROJECTS" ]; then
    echo "โ ะะต ัะดะฐะปะพัั ะฟะพะปััะธัั ัะฟะธัะพะบ ะฟัะพะตะบัะพะฒ. ะฃะฑะตะดะธัะตัั, ััะพ ะฒั ะฐะฒัะพัะธะทะพะฒะฐะฝั: vercel login"
    exit 1
fi

# ะะฐััะธะผ JSON ะธ ะฟะพะปััะฐะตะผ ะฟะพัะปะตะดะฝะธะน ะดะตะฟะปะพะนะผะตะฝั ะดะปั ะบะฐะถะดะพะณะพ ะฟัะพะตะบัะฐ
echo "$PROJECTS" | jq -r '.[] | "\(.id)|\(.name)"' | while IFS='|' read -r PROJECT_ID PROJECT_NAME; do
    echo ""
    echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
    echo "๐ฆ ะัะพะตะบั: $PROJECT_NAME ($PROJECT_ID)"
    echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
    
    # ะะพะปััะฐะตะผ ะฟะพัะปะตะดะฝะธะน ะดะตะฟะปะพะนะผะตะฝั
    LATEST_DEPLOYMENT=$(vercel list "$PROJECT_NAME" --json 2>/dev/null | jq -r '.[0].uid // empty')
    
    if [ -z "$LATEST_DEPLOYMENT" ]; then
        echo "โ๏ธ  ะะตั ะดะตะฟะปะพะนะผะตะฝัะพะฒ ะดะปั ะฟัะพะตะบัะฐ $PROJECT_NAME"
        continue
    fi
    
    DEPLOYMENT_URL=$(vercel list "$PROJECT_NAME" --json 2>/dev/null | jq -r '.[0].url // empty')
    
    echo "๐ ะะพัะปะตะดะฝะธะน ะดะตะฟะปะพะนะผะตะฝั: $LATEST_DEPLOYMENT"
    echo "๐ URL: $DEPLOYMENT_URL"
    echo ""
    echo "๐ Runtime ะปะพะณะธ:"
    echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
    
    if [ "$FOLLOW_FLAG" == "--follow" ]; then
        # ะกะปะตะดะธะผ ะทะฐ ะปะพะณะฐะผะธ ะฒ ัะตะฐะปัะฝะพะผ ะฒัะตะผะตะฝะธ (ะดะพ 5 ะผะธะฝัั)
        vercel logs "$LATEST_DEPLOYMENT" --follow
    else
        # ะะพะปััะฐะตะผ ะฟะพัะปะตะดะฝะธะต ะปะพะณะธ
        vercel logs "$LATEST_DEPLOYMENT"
    fi
    
    echo ""
done

echo ""
echo "โ ะะพัะพะฒะพ!"

